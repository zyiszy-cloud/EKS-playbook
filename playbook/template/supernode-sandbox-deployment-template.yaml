apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: supernode-sandbox-deployment-template
  annotations:
    description: "è¶…çº§èŠ‚ç‚¹Deploymentæ²™ç®±å¤ç”¨æµ‹è¯•æ¨¡æ¿ - ä¿®å¤ç‰ˆæœ¬"
    version: "4.1"
spec:
  serviceAccountName: tke-chaos
  entrypoint: deployment-sandbox-test
  
  arguments:
    parameters:
    # åŸºç¡€é…ç½®
    - name: cluster-id
      value: "tke-cluster"
    - name: webhook-url
      value: ""
    - name: kubeconfig-secret-name
      value: ""
    - name: namespace
      value: "tke-chaos-test"
    
    # æµ‹è¯•é…ç½®
    - name: deployment-name-prefix
      value: "sandbox-reuse-test"
    - name: replicas
      value: "1"
    - name: pod-image
      value: "nginx:alpine"
    - name: test-iterations
      value: "2"
    - name: delay-between-tests
      value: "20s"
    
    # èµ„æºé…ç½®
    - name: cpu-request
      value: "100m"
    - name: memory-request
      value: "128Mi"
    - name: cpu-limit
      value: "200m"
    - name: memory-limit
      value: "256Mi"

  templates:
  # ä¸»æµ‹è¯•æµç¨‹
  - name: deployment-sandbox-test
    inputs:
      parameters:
      - name: cluster-id
      - name: kubeconfig-secret-name
      - name: namespace
      - name: deployment-name-prefix
      - name: replicas
      - name: pod-image
      - name: test-iterations
      - name: delay-between-tests
      - name: cpu-request
      - name: memory-request
      - name: cpu-limit
      - name: memory-limit
      - name: webhook-url
    steps:
    # ç¬¬ä¸€æ­¥ï¼šéªŒè¯è¶…çº§èŠ‚ç‚¹
    - - name: verify-supernodes
        template: verify-supernodes
        arguments:
          parameters:
          - name: cluster-id
            value: "{{inputs.parameters.cluster-id}}"
          - name: kubeconfig-secret-name
            value: "{{inputs.parameters.kubeconfig-secret-name}}"
          - name: namespace
            value: "{{inputs.parameters.namespace}}"
    
    # ç¬¬äºŒæ­¥ï¼šè¿è¡Œéƒ¨ç½²æµ‹è¯•
    - - name: run-deployment-test
        template: run-deployment-test
        arguments:
          parameters:
          - name: cluster-id
            value: "{{inputs.parameters.cluster-id}}"
          - name: webhook-url
            value: "{{inputs.parameters.webhook-url}}"
          - name: kubeconfig-secret-name
            value: "{{inputs.parameters.kubeconfig-secret-name}}"
          - name: namespace
            value: "{{inputs.parameters.namespace}}"
          - name: deployment-name-prefix
            value: "{{inputs.parameters.deployment-name-prefix}}"
          - name: replicas
            value: "{{inputs.parameters.replicas}}"
          - name: pod-image
            value: "{{inputs.parameters.pod-image}}"
          - name: test-iterations
            value: "{{inputs.parameters.test-iterations}}"
          - name: delay-between-tests
            value: "{{inputs.parameters.delay-between-tests}}"
          - name: cpu-request
            value: "{{inputs.parameters.cpu-request}}"
          - name: memory-request
            value: "{{inputs.parameters.memory-request}}"
          - name: cpu-limit
            value: "{{inputs.parameters.cpu-limit}}"
          - name: memory-limit
            value: "{{inputs.parameters.memory-limit}}"

  # éªŒè¯è¶…çº§èŠ‚ç‚¹æ¨¡æ¿
  - name: verify-supernodes
    inputs:
      parameters:
      - name: cluster-id
      - name: kubeconfig-secret-name
      - name: namespace
    script:
      image: bitnami/kubectl:1.32.4
      command: [bash]
      source: |
        echo "ğŸ” éªŒè¯è¶…çº§èŠ‚ç‚¹çŠ¶æ€..."
        
        # è·å–è¶…çº§èŠ‚ç‚¹ä¿¡æ¯
        SUPERNODES=$(kubectl get nodes -l node.kubernetes.io/instance-type=eklet --no-headers 2>/dev/null | awk '{print $1}' | head -10)
        
        if [ -z "$SUPERNODES" ]; then
          echo "âŒ æœªå‘ç°è¶…çº§èŠ‚ç‚¹"
          exit 1
        fi
        
        echo "âœ… å‘ç°è¶…çº§èŠ‚ç‚¹:"
        for node in $SUPERNODES; do
          echo "- $node"
          # æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
          STATUS=$(kubectl get node $node --no-headers 2>/dev/null | awk '{print $2}')
          if [ "$STATUS" = "Ready" ]; then
            echo "âœ… $node çŠ¶æ€æ­£å¸¸"
          else
            echo "âš ï¸ $node çŠ¶æ€å¼‚å¸¸: $STATUS"
          fi
        done
        
        echo "success" > /tmp/result
    outputs:
      parameters:
      - name: result
        valueFrom:
          path: /tmp/result

  # è¿è¡Œéƒ¨ç½²æµ‹è¯•æ¨¡æ¿
  - name: run-deployment-test
    inputs:
      parameters:
      - name: cluster-id
      - name: webhook-url
      - name: kubeconfig-secret-name
      - name: namespace
      - name: deployment-name-prefix
      - name: replicas
      - name: pod-image
      - name: test-iterations
      - name: delay-between-tests
      - name: cpu-request
      - name: memory-request
      - name: cpu-limit
      - name: memory-limit
    script:
      image: alpine/k8s:1.28.4
      command: [bash]
      source: |
        echo "ğŸ“Š ä½¿ç”¨å†…ç½®shellè®¡ç®—ï¼Œæ¯«ç§’çº§ç²¾åº¦"
        
        # ç¡®ä¿å¿…è¦çš„å·¥å…·å¯ç”¨
        if ! command -v curl >/dev/null 2>&1; then
          echo "ğŸ”§ å®‰è£…curl..."
          apk add --no-cache curl 2>/dev/null || echo "âš ï¸ æ— æ³•å®‰è£…curlï¼Œå°†ä½¿ç”¨wget"
        fi
        
        if ! command -v bc >/dev/null 2>&1; then
          echo "ğŸ”§ å®‰è£…bc..."
          apk add --no-cache bc 2>/dev/null || echo "âš ï¸ æ— æ³•å®‰è£…bcï¼Œå°†ä½¿ç”¨awkè¿›è¡Œè®¡ç®—"
        fi
        
        # æµ‹è¯•å‚æ•°åˆå§‹åŒ–
        CLUSTER_ID="{{inputs.parameters.cluster-id}}"
        WEBHOOK_URL="{{inputs.parameters.webhook-url}}"
        NAMESPACE="{{inputs.parameters.namespace}}"
        DEPLOYMENT_NAME_PREFIX="{{inputs.parameters.deployment-name-prefix}}"
        REPLICAS={{inputs.parameters.replicas}}
        POD_IMAGE="{{inputs.parameters.pod-image}}"
        CPU_REQUEST="{{inputs.parameters.cpu-request}}"
        MEMORY_REQUEST="{{inputs.parameters.memory-request}}"
        CPU_LIMIT="{{inputs.parameters.cpu-limit}}"
        MEMORY_LIMIT="{{inputs.parameters.memory-limit}}"
        ITERATIONS="{{inputs.parameters.test-iterations}}"
        DELAY="{{inputs.parameters.delay-between-tests}}"
        TIMEOUT="300s"
        
        # è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºæ¥æ”¶åˆ°çš„å‚æ•°
        echo "ğŸ” æ¥æ”¶åˆ°çš„æµ‹è¯•å‚æ•°:"
        echo "  é›†ç¾¤ID: $CLUSTER_ID"
        echo "  Webhook URL: '$WEBHOOK_URL'"
        echo "  å‘½åç©ºé—´: $NAMESPACE"
        echo "  Podå‰¯æœ¬æ•°: $REPLICAS"
        echo "  Podé•œåƒ: $POD_IMAGE"
        echo "  æµ‹è¯•è¿­ä»£: $ITERATIONS"
        echo "  é”€æ¯é—´éš”: $DELAY"
        echo ""
        
        # éªŒè¯å…³é”®å‚æ•°
        if [ "$REPLICAS" -eq 0 ] 2>/dev/null; then
          echo "âŒ é”™è¯¯ï¼šPodå‰¯æœ¬æ•°ä¸º0ï¼Œä½¿ç”¨é»˜è®¤å€¼1"
          REPLICAS=1
        fi
        
        echo "ğŸ“Š æœ€ç»ˆä½¿ç”¨çš„Podå‰¯æœ¬æ•°: $REPLICAS"
        
        # åˆå§‹åŒ–ç»Ÿè®¡å˜é‡
        TOTAL_TESTS=$ITERATIONS
        SUCCESSFUL_TESTS=0
        FAILED_TESTS=0
        STARTUP_TIMES=""
        REUSED_SANDBOXES=0  # æ²™ç®±å¤ç”¨è®¡æ•°å™¨
        
        echo "========================================"
        echo "è¶…çº§èŠ‚ç‚¹Deploymentæ²™ç®±å¤ç”¨æ€§èƒ½æµ‹è¯•"
        echo "========================================"
        echo "é›†ç¾¤ID: $CLUSTER_ID"
        echo "æµ‹è¯•è¿­ä»£: $ITERATIONS æ¬¡"
        echo "Podå‰¯æœ¬æ•°: $REPLICAS ä¸ª"
        echo "å‘½åç©ºé—´: $NAMESPACE"
        echo "Podé•œåƒ: $POD_IMAGE"
        echo "èµ„æºé™åˆ¶: CPU=$CPU_LIMIT, Memory=$MEMORY_LIMIT"
        echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "========================================"
        
        # ğŸ” è·å–è¶…çº§èŠ‚ç‚¹ä¿¡æ¯
        echo "ğŸ” è·å–è¶…çº§èŠ‚ç‚¹ä¿¡æ¯..."
        SUPERNODES=$(kubectl get nodes -l node.kubernetes.io/instance-type=eklet --no-headers 2>/dev/null | awk '{print $1}' | head -1)
        
        if [ -z "$SUPERNODES" ]; then
          echo "âŒ æœªå‘ç°è¶…çº§èŠ‚ç‚¹"
          exit 1
        fi
        
        node_name=$(echo $SUPERNODES | head -1)
        echo "ğŸ“Š è¶…çº§èŠ‚ç‚¹ä¿¡æ¯:"
        echo "èŠ‚ç‚¹æ•°é‡: $(echo $SUPERNODES | wc -w)"
        for node in $SUPERNODES; do
          echo "- $node"
        done
        echo "ğŸ¯ é€‰æ‹©æµ‹è¯•èŠ‚ç‚¹: $node_name"
        
        echo "ğŸ“‹ æµ‹è¯•ç­–ç•¥: ä¸¤æ¬¡Podåˆ›å»ºå¯¹æ¯”æµ‹è¯•ï¼ˆåŸºå‡†æµ‹è¯• vs æ²™ç®±å¤ç”¨æµ‹è¯•ï¼‰"
        echo "â±ï¸  é”€æ¯é—´éš”: $DELAY ($(echo $DELAY | sed 's/s/ç§’/')åé”€æ¯Pod)"
        
        # æ‰§è¡Œæµ‹è¯•è¿­ä»£
        for i in $(seq 1 $ITERATIONS); do
          echo ""
          echo "========================================"
          if [ $i -eq 1 ]; then
            echo "ç¬¬${i}æ¬¡æµ‹è¯•ï¼šåŸºå‡†æµ‹è¯•ï¼ˆé¦–æ¬¡åˆ›å»ºæ²™ç®±ï¼‰"
            TEST_TYPE="åŸºå‡†æµ‹è¯•"
          else
            echo "ç¬¬${i}æ¬¡æµ‹è¯•ï¼šæ²™ç®±å¤ç”¨æµ‹è¯•"
            TEST_TYPE="æ²™ç®±å¤ç”¨æµ‹è¯•"
          fi
          echo "========================================"
          
          DEPLOYMENT_NAME="${DEPLOYMENT_NAME_PREFIX}-sandbox-reuse-test"
          
          echo "ğŸš€ åˆ›å»ºDeployment: $DEPLOYMENT_NAME (åŒ…å« $REPLICAS ä¸ªPod) - $TEST_TYPE"
          echo "  ğŸ“ åˆ›å»ºDeploymenté…ç½®: $REPLICAS ä¸ªå‰¯æœ¬"
          echo "  ğŸ¯ ç›®æ ‡: å¹¶å‘åˆ›å»º $REPLICAS ä¸ªPod"
          
          # è®°å½•Deploymentåˆ›å»ºå¼€å§‹æ—¶é—´ï¼ˆæ¯«ç§’çº§ç²¾åº¦ï¼‰
          # ä½¿ç”¨æ›´å¯é çš„æ—¶é—´æˆ³è·å–æ–¹æ³•
          DEPLOYMENT_CREATE_TIMESTAMP=$(date -Iseconds)
          
          # è·å–ç§’çº§æ—¶é—´æˆ³
          DEPLOYMENT_START_SEC=$(date +%s)
          
          # è·å–æ¯«ç§’çº§æ—¶é—´æˆ³ï¼ˆä½¿ç”¨å¤šç§æ–¹æ³•ï¼‰
          DEPLOYMENT_START_TIME=""
          
          # æ–¹æ³•1: å°è¯•ä½¿ç”¨date +%s%3N
          if command -v date >/dev/null 2>&1; then
            TEMP_TIME=$(date +%s%3N 2>/dev/null)
            if [[ "$TEMP_TIME" =~ ^[0-9]+$ ]] && [ ${#TEMP_TIME} -gt 10 ]; then
              DEPLOYMENT_START_TIME="$TEMP_TIME"
            fi
          fi
          
          # æ–¹æ³•2: å¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œä½¿ç”¨Pythonè·å–æ¯«ç§’çº§æ—¶é—´æˆ³
          if [ -z "$DEPLOYMENT_START_TIME" ]; then
            DEPLOYMENT_START_TIME=$(python3 -c "import time; print(int(time.time() * 1000))" 2>/dev/null || echo "")
          fi
          
          # æ–¹æ³•3: å¦‚æœPythonä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨ç§’çº§æ—¶é—´æˆ³*1000
          if [ -z "$DEPLOYMENT_START_TIME" ]; then
            DEPLOYMENT_START_TIME=$((DEPLOYMENT_START_SEC * 1000))
            echo "  âš ï¸ ä½¿ç”¨ç§’çº§æ—¶é—´æˆ³*1000ä½œä¸ºæ¯«ç§’çº§æ—¶é—´æˆ³"
          fi
          
          echo "  ğŸ” æ—¶é—´æˆ³è·å–è¯¦æƒ…:"
          echo "    ç§’çº§æ—¶é—´æˆ³: $DEPLOYMENT_START_SEC"
          echo "    æ¯«ç§’çº§æ—¶é—´æˆ³: $DEPLOYMENT_START_TIME"
          
          echo "  ğŸ” Deploymentåˆ›å»ºå¼€å§‹æ—¶é—´: $DEPLOYMENT_CREATE_TIMESTAMP"
          echo "  ğŸ” Deploymentåˆ›å»ºæ—¶é—´æˆ³(ms): $DEPLOYMENT_START_TIME"
          
          # åˆ›å»ºä¼˜åŒ–çš„Deployment
          kubectl apply -f - <<DEPLOY_EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: $DEPLOYMENT_NAME
          namespace: $NAMESPACE
          labels:
            app: sandbox-deployment-test
            cluster-id: "$CLUSTER_ID"
            sandbox-reuse-test: "true"
            version: "v1"
          annotations:
            deployment.kubernetes.io/revision: "1"
            description: "è¶…çº§èŠ‚ç‚¹æ²™ç®±å¤ç”¨æµ‹è¯•Deployment"
            deployment.kubernetes.io/desired-replicas: "$REPLICAS"
            created-at: "$(date -Iseconds)"
        spec:
          replicas: $REPLICAS
          
          # éƒ¨ç½²ç­–ç•¥ï¼šæ”¯æŒå¹¶å‘åˆ›å»º
          strategy:
            type: RollingUpdate
            rollingUpdate:
              maxUnavailable: 0
              maxSurge: 100%  # å…è®¸åŒæ—¶åˆ›å»ºæ‰€æœ‰Pod
          
          # è¿›åº¦æˆªæ­¢æ—¶é—´
          progressDeadlineSeconds: 600
          
          # ä¿®è®¢å†å²é™åˆ¶
          revisionHistoryLimit: 3
          
          selector:
            matchLabels:
              app: sandbox-deployment-test
              sandbox-reuse-test: "true"
          
          template:
            metadata:
              labels:
                app: sandbox-deployment-test
                cluster-id: "$CLUSTER_ID"
                sandbox-reuse-test: "true"
                version: "v1"
              annotations:
                # ç¦ç”¨LoadBalanceråŠŸèƒ½ï¼ˆè…¾è®¯äº‘ç‰¹å®šï¼‰
                service.cloud.tencent.com/direct-access: "true"
                # Podåˆ›å»ºæ—¶é—´æˆ³
                created-at: "$(date -Iseconds)"
            spec:
              # èŠ‚ç‚¹è°ƒåº¦é…ç½®
              nodeName: $node_name
              nodeSelector:
                node.kubernetes.io/instance-type: eklet
              
              # å®¹å¿åº¦é…ç½®
              tolerations:
              - operator: Exists
                effect: NoSchedule
              - key: node.kubernetes.io/not-ready
                operator: Exists
                effect: NoExecute
                tolerationSeconds: 300
              
              # äº²å’Œæ€§é…ç½®ï¼ˆå¯é€‰ï¼šåˆ†æ•£éƒ¨ç½²ï¼‰
              affinity:
                podAntiAffinity:
                  preferredDuringSchedulingIgnoredDuringExecution:
                  - weight: 50
                    podAffinityTerm:
                      labelSelector:
                        matchLabels:
                          app: sandbox-deployment-test
                      topologyKey: kubernetes.io/hostname
              
              containers:
              - name: test-container
                image: $POD_IMAGE
                imagePullPolicy: IfNotPresent
                
                resources:
                  requests:
                    cpu: $CPU_REQUEST
                    memory: $MEMORY_REQUEST
                  limits:
                    cpu: $CPU_LIMIT
                    memory: $MEMORY_LIMIT
                
                command: ["/bin/sh"]
                args: ["-c", "echo 'Pod started at $(date) on node $node_name' && sleep 300"]
                
                # ä¼˜åŒ–çš„å°±ç»ªæ€§æ¢é’ˆ
                readinessProbe:
                  exec:
                    command: ["/bin/sh", "-c", "echo ready"]
                  initialDelaySeconds: 1
                  periodSeconds: 1
                  timeoutSeconds: 1
                  failureThreshold: 1
                
                # å­˜æ´»æ€§æ¢é’ˆ
                livenessProbe:
                  exec:
                    command: ["/bin/sh", "-c", "echo alive"]
                  initialDelaySeconds: 5
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
                
                # å®‰å…¨ä¸Šä¸‹æ–‡
                securityContext:
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: false
                  runAsNonRoot: false
              
              restartPolicy: Always
        DEPLOY_EOF
          
          if [ $? -ne 0 ]; then
            echo "âŒ Deploymentåˆ›å»ºå¤±è´¥"
            FAILED_TESTS=$((FAILED_TESTS + 1))
            continue
          fi
          
          # ç­‰å¾…æ‰€æœ‰Podè¢«åˆ›å»ºï¼ˆä¸ç­‰å¾…å¯åŠ¨å®Œæˆï¼‰
          echo "  ğŸ“Š ç›‘æ§Podåˆ›å»ºè¿‡ç¨‹..."
          echo "  ğŸ¯ ç›®æ ‡: åˆ›å»º $REPLICAS ä¸ªPod"
          # å®‰å…¨å¤„ç†è¶…æ—¶å€¼ï¼Œæ”¯æŒå¸¦såç¼€å’Œçº¯æ•°å­—
          if [[ "$TIMEOUT" =~ ^[0-9]+s$ ]]; then
            timeout_seconds=$(echo $TIMEOUT | sed 's/s$//')
          elif [[ "$TIMEOUT" =~ ^[0-9]+$ ]]; then
            timeout_seconds=$TIMEOUT
          else
            timeout_seconds=300  # é»˜è®¤5åˆ†é’Ÿ
          fi
          count=0
          all_pods_created=false
          pod_creation_time=""
          
          # ç¬¬ä¸€é˜¶æ®µï¼šç­‰å¾…æ‰€æœ‰Podè¢«åˆ›å»ºï¼ˆä¸ç®¡æ˜¯å¦Readyï¼‰
          while [ $count -lt $timeout_seconds ]; do
            TOTAL_PODS=$(kubectl get pods -n $NAMESPACE -l sandbox-reuse-test=true --no-headers 2>/dev/null | wc -l | tr -d ' ')
            
            # æ¯3ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
            if [ $((count % 3)) -eq 0 ]; then
              echo "  â³ ç­‰å¾…Podåˆ›å»º... å½“å‰å·²åˆ›å»º: $TOTAL_PODS/$REPLICAS (${count}s)"
              # æ˜¾ç¤ºDeploymentçŠ¶æ€
              READY_REPLICAS=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
              AVAILABLE_REPLICAS=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.status.availableReplicas}' 2>/dev/null || echo "0")
              UPDATED_REPLICAS=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.status.updatedReplicas}' 2>/dev/null || echo "0")
              echo "  ğŸ“Š DeploymentçŠ¶æ€: Ready=$READY_REPLICAS, Available=$AVAILABLE_REPLICAS, Updated=$UPDATED_REPLICAS, Target=$REPLICAS"
            fi
            
            if [ "$TOTAL_PODS" -eq "$REPLICAS" ]; then
              POD_CREATION_END_TIME=$(date +%s%3N)
              
              echo "  âœ… æ‰€æœ‰ $REPLICAS ä¸ªPodå·²åˆ›å»ºï¼Œç«‹å³è·å–æ—¶é—´ä¿¡æ¯..."
              
              # ğŸ¯ ç«‹å³è·å–å¹¶å­˜å‚¨Podæ—¶é—´ä¿¡æ¯ï¼ˆé¿å…Podè¢«åˆ é™¤ï¼‰
              echo "  ğŸ” ç«‹å³è·å–Podæ—¶é—´ä¿¡æ¯ï¼ˆé¿å…Podåˆ é™¤åæ— æ³•è·å–ï¼‰..."
              
              # ğŸ¯ ç«‹å³è·å–æ‰€æœ‰Podçš„æ—¶é—´ä¿¡æ¯å¹¶å­˜å‚¨
              CURRENT_TEST_POD_DATA=""  # å­˜å‚¨å½“å‰æµ‹è¯•çš„Podæ—¶é—´æ•°æ®
              DEPLOYMENT_START_TS=$DEPLOYMENT_START_SEC
              
              echo "  ğŸ” Deploymentåˆ›å»ºæ—¶é—´æˆ³(ç§’): $DEPLOYMENT_START_TS"
              DEPLOYMENT_TIME_DISPLAY=$(python3 -c "import datetime; dt = datetime.datetime.fromtimestamp($DEPLOYMENT_START_TS); print(dt.strftime(\"%Y-%m-%d %H:%M:%S\"))" 2>/dev/null || echo "æ—¶é—´æ ¼å¼åŒ–å¤±è´¥")
              echo "  ğŸ” Deploymentåˆ›å»ºæ—¶é—´: $DEPLOYMENT_TIME_DISPLAY"
              
              # ğŸ¯ ç­‰å¾…å®¹å™¨å¯åŠ¨åè·å–å®Œæ•´æ—¶é—´ä¿¡æ¯
              echo "  â³ ç­‰å¾…å®¹å™¨å¯åŠ¨ä»¥è·å–å‡†ç¡®çš„æ—¶é—´ä¿¡æ¯..."
              
              # ç­‰å¾…æ‰€æœ‰Podçš„å®¹å™¨å¯åŠ¨ï¼ˆæœ€å¤šç­‰å¾…60ç§’ï¼‰
              container_wait_count=0
              while [ $container_wait_count -lt 60 ]; do
                ALL_CONTAINERS_STARTED=true
                
                for pod in $(kubectl get pods -n $NAMESPACE -l sandbox-reuse-test=true --no-headers -o custom-columns=NAME:.metadata.name); do
                  CONTAINER_START_TIME=$(kubectl get pod $pod -n $NAMESPACE -o jsonpath='{.status.containerStatuses[0].state.running.startedAt}' 2>/dev/null)
                  if [ -z "$CONTAINER_START_TIME" ]; then
                    ALL_CONTAINERS_STARTED=false
                    break
                  fi
                done
                
                if [ "$ALL_CONTAINERS_STARTED" = true ]; then
                  echo "  âœ… æ‰€æœ‰å®¹å™¨å·²å¯åŠ¨ï¼Œå¼€å§‹è·å–æ—¶é—´ä¿¡æ¯"
                  break
                fi
                
                if [ $((container_wait_count % 10)) -eq 0 ]; then
                  echo "  â³ ç­‰å¾…å®¹å™¨å¯åŠ¨... (${container_wait_count}s)"
                fi
                
                sleep 1
                container_wait_count=$((container_wait_count + 1))
              done
              
              if [ "$ALL_CONTAINERS_STARTED" = false ]; then
                echo "  âš ï¸ éƒ¨åˆ†å®¹å™¨æœªå¯åŠ¨ï¼Œå°†ä½¿ç”¨å¯ç”¨çš„æ—¶é—´ä¿¡æ¯"
              fi
              
              # ç°åœ¨è·å–æ‰€æœ‰Podçš„å®Œæ•´æ—¶é—´ä¿¡æ¯
              for pod in $(kubectl get pods -n $NAMESPACE -l sandbox-reuse-test=true --no-headers -o custom-columns=NAME:.metadata.name); do
                echo "    ğŸ“Š è·å–Pod $podçš„å®Œæ•´æ—¶é—´ä¿¡æ¯..."
                
                # 1. è·å–PodåŸºæœ¬ä¿¡æ¯
                POD_CREATE_TIME=$(kubectl get pod $pod -n $NAMESPACE -o jsonpath='{.metadata.creationTimestamp}' 2>/dev/null)
                NODE_NAME=$(kubectl get pod $pod -n $NAMESPACE -o jsonpath='{.spec.nodeName}' 2>/dev/null)
                
                # 2. è·å–PodçŠ¶æ€æ¡ä»¶æ—¶é—´
                SCHEDULED_TIME=$(kubectl get pod $pod -n $NAMESPACE -o jsonpath='{.status.conditions[?(@.type=="PodScheduled")].lastTransitionTime}' 2>/dev/null)
                INITIALIZED_TIME=$(kubectl get pod $pod -n $NAMESPACE -o jsonpath='{.status.conditions[?(@.type=="Initialized")].lastTransitionTime}' 2>/dev/null)
                READY_TIME=$(kubectl get pod $pod -n $NAMESPACE -o jsonpath='{.status.conditions[?(@.type=="Ready")].lastTransitionTime}' 2>/dev/null)
                CONTAINERS_READY_TIME=$(kubectl get pod $pod -n $NAMESPACE -o jsonpath='{.status.conditions[?(@.type=="ContainersReady")].lastTransitionTime}' 2>/dev/null)
                
                # 3. è·å–å®¹å™¨çŠ¶æ€æ—¶é—´ï¼ˆç°åœ¨åº”è¯¥æœ‰å€¼äº†ï¼‰
                CONTAINER_START_TIME=$(kubectl get pod $pod -n $NAMESPACE -o jsonpath='{.status.containerStatuses[0].state.running.startedAt}' 2>/dev/null)
                
                echo "      ğŸ“… è·å–çš„æ—¶é—´ä¿¡æ¯:"
                echo "        Podåˆ›å»ºæ—¶é—´: $POD_CREATE_TIME"
                echo "        Podè°ƒåº¦æ—¶é—´: $SCHEDULED_TIME"
                echo "        Podåˆå§‹åŒ–æ—¶é—´: $INITIALIZED_TIME"
                echo "        å®¹å™¨å¯åŠ¨æ—¶é—´: $CONTAINER_START_TIME"
                echo "        å®¹å™¨å°±ç»ªæ—¶é—´: $CONTAINERS_READY_TIME"
                echo "        Podå°±ç»ªæ—¶é—´: $READY_TIME"
                echo "        è¿è¡ŒèŠ‚ç‚¹: $NODE_NAME"
                
                # 4. å¦‚æœå®¹å™¨å¯åŠ¨æ—¶é—´ä»ä¸ºç©ºï¼Œå°è¯•ä»Eventsè·å–
                if [ -z "$CONTAINER_START_TIME" ]; then
                  echo "      ğŸ” å®¹å™¨å¯åŠ¨æ—¶é—´ä¸ºç©ºï¼Œå°è¯•ä»Eventsè·å–..."
                  
                  # ä»Podäº‹ä»¶ä¸­è·å–å®¹å™¨å¯åŠ¨ç›¸å…³çš„æ—¶é—´
                  STARTED_EVENT_TIME=$(kubectl get events -n $NAMESPACE --field-selector involvedObject.name=$pod --sort-by='.firstTimestamp' -o custom-columns=TIME:.firstTimestamp,REASON:.reason,MESSAGE:.message --no-headers 2>/dev/null | grep -E "(Started|Pulled)" | tail -1 | awk '{print $1}')
                  
                  if [ -n "$STARTED_EVENT_TIME" ]; then
                    CONTAINER_START_TIME="$STARTED_EVENT_TIME"
                    echo "      âœ… ä»Eventsè·å–åˆ°å®¹å™¨å¯åŠ¨æ—¶é—´: $CONTAINER_START_TIME"
                  else
                    echo "      âš ï¸ æ— æ³•ä»Eventsè·å–å®¹å™¨å¯åŠ¨æ—¶é—´"
                  fi
                fi
                
                # 5. è®¡ç®—å¹¶å­˜å‚¨æ—¶é—´æŒ‡æ ‡
                if [ -n "$POD_CREATE_TIME" ] && [ -n "$CONTAINER_START_TIME" ]; then
                  # è®¡ç®—ç²¾ç¡®çš„æ²™ç®±åˆå§‹åŒ–æ—¶é—´ï¼ˆå¸¦è°ƒè¯•ä¿¡æ¯ï¼‰
                  echo "      ğŸ” è°ƒè¯•Pythonè®¡ç®—:"
                  echo "        Podåˆ›å»ºæ—¶é—´: '$POD_CREATE_TIME'"
                  echo "        å®¹å™¨å¯åŠ¨æ—¶é—´: '$CONTAINER_START_TIME'"
                  
                  SANDBOX_INIT_RESULT=$(python3 -c "
        import datetime
        import sys
        try:
            start_str = '$POD_CREATE_TIME'.replace('Z', '+00:00')
            end_str = '$CONTAINER_START_TIME'.replace('Z', '+00:00')
            print(f'DEBUG: start_str={start_str}', file=sys.stderr)
            print(f'DEBUG: end_str={end_str}', file=sys.stderr)
    
            start = datetime.datetime.fromisoformat(start_str)
            end = datetime.datetime.fromisoformat(end_str)
            duration = (end - start).total_seconds()
    
            print(f'DEBUG: duration={duration}', file=sys.stderr)
    
            if duration < 0: duration = 0
            print(f'{duration:.3f}')
        except Exception as e:
            print(f'DEBUG: Exception={e}', file=sys.stderr)
            print('0.000')
        " 2>&1)
                  
                  # æå–å®é™…ç»“æœï¼ˆæœ€åä¸€è¡Œï¼‰
                  SANDBOX_INIT_DURATION=$(echo "$SANDBOX_INIT_RESULT" | tail -1)
                  echo "      ğŸ” Pythonè®¡ç®—ç»“æœ: $SANDBOX_INIT_DURATION"
                  
                  # è®¡ç®—ä»Deploymentå¼€å§‹åˆ°Podåˆ›å»ºçš„æ—¶é—´ï¼ˆä¿®å¤æ—¶åŒºé—®é¢˜ï¼‰
                  POD_CREATION_RESULT=$(python3 -c "
        import datetime
        import sys
        try:
            # ä½¿ç”¨UTCæ—¶åŒºåˆ›å»ºdeployment_startæ—¶é—´
            deployment_start = datetime.datetime.fromtimestamp($DEPLOYMENT_START_TS, tz=datetime.timezone.utc)
            pod_create = datetime.datetime.fromisoformat('$POD_CREATE_TIME'.replace('Z', '+00:00'))
            duration = (pod_create - deployment_start).total_seconds()
    
            print(f'DEBUG: deployment_start={deployment_start}', file=sys.stderr)
            print(f'DEBUG: pod_create={pod_create}', file=sys.stderr)
            print(f'DEBUG: pod_creation_duration={duration}', file=sys.stderr)
    
            if duration < 0: duration = 0
            print(f'{duration:.3f}')
        except Exception as e:
            print(f'DEBUG: Pod creation Exception={e}', file=sys.stderr)
            print('0.000')
        " 2>&1)
                  
                  POD_CREATION_DURATION=$(echo "$POD_CREATION_RESULT" | tail -1)
                  echo "      ğŸ” Podåˆ›å»ºæ—¶é—´è®¡ç®—ç»“æœ: $POD_CREATION_DURATION"
                  
                  # è®¡ç®—ç«¯åˆ°ç«¯æ—¶é—´ï¼ˆä¿®å¤æ—¶åŒºé—®é¢˜ï¼‰
                  END_TO_END_RESULT=$(python3 -c "
        import datetime
        import sys
        try:
            # ä½¿ç”¨UTCæ—¶åŒºåˆ›å»ºdeployment_startæ—¶é—´
            deployment_start = datetime.datetime.fromtimestamp($DEPLOYMENT_START_TS, tz=datetime.timezone.utc)
            container_start = datetime.datetime.fromisoformat('$CONTAINER_START_TIME'.replace('Z', '+00:00'))
            duration = (container_start - deployment_start).total_seconds()
    
            print(f'DEBUG: deployment_start={deployment_start}', file=sys.stderr)
            print(f'DEBUG: container_start={container_start}', file=sys.stderr)
            print(f'DEBUG: end_to_end_duration={duration}', file=sys.stderr)
    
            if duration < 0: duration = 0
            print(f'{duration:.3f}')
        except Exception as e:
            print(f'DEBUG: End-to-end Exception={e}', file=sys.stderr)
            print('0.000')
        " 2>&1)
                  
                  END_TO_END_DURATION=$(echo "$END_TO_END_RESULT" | tail -1)
                  echo "      ğŸ” ç«¯åˆ°ç«¯æ—¶é—´è®¡ç®—ç»“æœ: $END_TO_END_DURATION"
                  
                  echo "      â±ï¸  è®¡ç®—çš„æ—¶é—´æŒ‡æ ‡:"
                  echo "        Podåˆ›å»ºè€—æ—¶: ${POD_CREATION_DURATION}ç§’"
                  echo "        æ²™ç®±åˆå§‹åŒ–è€—æ—¶: ${SANDBOX_INIT_DURATION}ç§’"
                  echo "        ç«¯åˆ°ç«¯è€—æ—¶: ${END_TO_END_DURATION}ç§’"
                  
                  # å­˜å‚¨Podæ•°æ®ï¼ˆæ ¼å¼ï¼špod_name:pod_creation:sandbox_init:end_to_endï¼‰
                  POD_DATA="${pod}:${POD_CREATION_DURATION}:${SANDBOX_INIT_DURATION}:${END_TO_END_DURATION}"
                  if [ -z "$CURRENT_TEST_POD_DATA" ]; then
                    CURRENT_TEST_POD_DATA="$POD_DATA"
                  else
                    CURRENT_TEST_POD_DATA="$CURRENT_TEST_POD_DATA|$POD_DATA"
                  fi
                  
                  echo "      âœ… Podæ•°æ®å·²å­˜å‚¨: $POD_DATA"
                  
                elif [ -n "$POD_CREATE_TIME" ]; then
                  # åªæœ‰Podåˆ›å»ºæ—¶é—´ï¼Œè®¡ç®—åŸºæœ¬æŒ‡æ ‡ï¼ˆä¿®å¤æ—¶åŒºé—®é¢˜ï¼‰
                  POD_CREATION_RESULT=$(python3 -c "
        import datetime
        import sys
        try:
            # ä½¿ç”¨UTCæ—¶åŒºåˆ›å»ºdeployment_startæ—¶é—´
            deployment_start = datetime.datetime.fromtimestamp($DEPLOYMENT_START_TS, tz=datetime.timezone.utc)
            pod_create = datetime.datetime.fromisoformat('$POD_CREATE_TIME'.replace('Z', '+00:00'))
            duration = (pod_create - deployment_start).total_seconds()
    
            print(f'DEBUG: deployment_start={deployment_start}', file=sys.stderr)
            print(f'DEBUG: pod_create={pod_create}', file=sys.stderr)
            print(f'DEBUG: basic_pod_creation_duration={duration}', file=sys.stderr)
    
            if duration < 0: duration = 0
            print(f'{duration:.3f}')
        except Exception as e:
            print(f'DEBUG: Basic Pod creation Exception={e}', file=sys.stderr)
            print('0.000')
        " 2>&1)
                  
                  POD_CREATION_DURATION=$(echo "$POD_CREATION_RESULT" | tail -1)
                  echo "      ğŸ” åŸºæœ¬Podåˆ›å»ºæ—¶é—´è®¡ç®—ç»“æœ: $POD_CREATION_DURATION"
                  
                  echo "      â±ï¸  åŸºæœ¬æ—¶é—´æŒ‡æ ‡:"
                  echo "        Podåˆ›å»ºè€—æ—¶: ${POD_CREATION_DURATION}ç§’"
                  echo "      âš ï¸  å®¹å™¨å¯åŠ¨æ—¶é—´æœªè·å–åˆ°ï¼Œæ²™ç®±åˆå§‹åŒ–æ—¶é—´æ— æ³•è®¡ç®—"
                  
                  # å­˜å‚¨åŸºæœ¬æ•°æ®
                  POD_DATA="${pod}:${POD_CREATION_DURATION}:0.000:0.000"
                  if [ -z "$CURRENT_TEST_POD_DATA" ]; then
                    CURRENT_TEST_POD_DATA="$POD_DATA"
                  else
                    CURRENT_TEST_POD_DATA="$CURRENT_TEST_POD_DATA|$POD_DATA"
                  fi
                  
                  echo "      âš ï¸  Podæ•°æ®å·²å­˜å‚¨ï¼ˆéƒ¨åˆ†ï¼‰: $POD_DATA"
                else
                  echo "      âŒ æ— æ³•è·å–Podæ—¶é—´ä¿¡æ¯"
                fi
              done
              
              echo "  ğŸ“Š å½“å‰æµ‹è¯•Podæ•°æ®å­˜å‚¨å®Œæˆ: $CURRENT_TEST_POD_DATA"
              
              # ğŸ¯ åŸºäºå­˜å‚¨æ•°æ®è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
              echo "  ğŸ“Š åŸºäºå­˜å‚¨æ•°æ®è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡..."
              
              if [ -n "$CURRENT_TEST_POD_DATA" ]; then
                # è§£æå­˜å‚¨çš„Podæ•°æ®å¹¶è®¡ç®—ç»Ÿè®¡
                POD_CREATION_TIMES=""
                SANDBOX_INIT_TIMES=""
                END_TO_END_TIMES=""
                
                # è§£ææ¯ä¸ªPodçš„æ•°æ®ï¼ˆæ ¼å¼ï¼špod_name:pod_creation:sandbox_init:end_to_endï¼‰
                IFS='|' read -ra POD_ENTRIES <<< "$CURRENT_TEST_POD_DATA"
                for entry in "${POD_ENTRIES[@]}"; do
                  IFS=':' read -ra POD_INFO <<< "$entry"
                  if [ ${#POD_INFO[@]} -eq 4 ]; then
                    POD_NAME="${POD_INFO[0]}"
                    POD_CREATION="${POD_INFO[1]}"
                    SANDBOX_INIT="${POD_INFO[2]}"
                    END_TO_END="${POD_INFO[3]}"
                    
                    # ç´¯åŠ æ—¶é—´æ•°æ®
                    POD_CREATION_TIMES="$POD_CREATION_TIMES $POD_CREATION"
                    SANDBOX_INIT_TIMES="$SANDBOX_INIT_TIMES $SANDBOX_INIT"
                    END_TO_END_TIMES="$END_TO_END_TIMES $END_TO_END"
                    
                    echo "    Pod $POD_NAME: åˆ›å»º=${POD_CREATION}s, æ²™ç®±=${SANDBOX_INIT}s, ç«¯åˆ°ç«¯=${END_TO_END}s"
                  fi
                done
                
                # è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
                if [ -n "$POD_CREATION_TIMES" ]; then
                  POD_CREATION_STATS=$(echo "$POD_CREATION_TIMES" | awk '{
                    sum = 0; min = $1; max = $1; count = NF
                    for(i=1; i<=NF; i++) {
                      sum += $i
                      if($i < min) min = $i
                      if($i > max) max = $i
                    }
                    avg = sum / count
                    printf "%.3f %.3f %.3f", avg, min, max
                  }')
                  
                  SANDBOX_INIT_STATS=$(echo "$SANDBOX_INIT_TIMES" | awk '{
                    sum = 0; min = $1; max = $1; count = NF
                    for(i=1; i<=NF; i++) {
                      sum += $i
                      if($i < min) min = $i
                      if($i > max) max = $i
                    }
                    avg = sum / count
                    printf "%.3f %.3f %.3f", avg, min, max
                  }')
                  
                  AVG_POD_CREATION=$(echo "$POD_CREATION_STATS" | awk '{print $1}')
                  MIN_POD_CREATION=$(echo "$POD_CREATION_STATS" | awk '{print $2}')
                  MAX_POD_CREATION=$(echo "$POD_CREATION_STATS" | awk '{print $3}')
                  
                  AVG_SANDBOX_INIT=$(echo "$SANDBOX_INIT_STATS" | awk '{print $1}')
                  MIN_SANDBOX_INIT=$(echo "$SANDBOX_INIT_STATS" | awk '{print $2}')
                  MAX_SANDBOX_INIT=$(echo "$SANDBOX_INIT_STATS" | awk '{print $3}')
                  
                  echo "  ğŸ“Š ç»Ÿè®¡ç»“æœ:"
                  echo "    Podåˆ›å»ºæ—¶é—´ - å¹³å‡: ${AVG_POD_CREATION}s, æœ€å°: ${MIN_POD_CREATION}s, æœ€å¤§: ${MAX_POD_CREATION}s"
                  echo "    æ²™ç®±åˆå§‹åŒ–æ—¶é—´ - å¹³å‡: ${AVG_SANDBOX_INIT}s, æœ€å°: ${MIN_SANDBOX_INIT}s, æœ€å¤§: ${MAX_SANDBOX_INIT}s"
                  
                  # ä½¿ç”¨å¹³å‡æ²™ç®±åˆå§‹åŒ–æ—¶é—´ä½œä¸ºä¸»è¦æŒ‡æ ‡ï¼ˆç¬¦åˆæ‚¨çš„è„šæœ¬æ€è·¯ï¼‰
                  pod_creation_time_sec="$AVG_SANDBOX_INIT"
                  echo "  âœ… ä½¿ç”¨å¹³å‡æ²™ç®±åˆå§‹åŒ–æ—¶é—´: ${pod_creation_time_sec}ç§’"
                else
                  echo "  âŒ æ— æ³•è§£æPodæ—¶é—´æ•°æ®"
                  pod_creation_time_sec="1.0"
                fi
              else
                echo "  âŒ æ²¡æœ‰å­˜å‚¨çš„Podæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼"
                pod_creation_time_sec="1.0"
              fi
              all_pods_created=true
              break
            fi
            
            if [ $((count % 5)) -eq 0 ] && [ $count -gt 0 ]; then
              echo "  â³ ç­‰å¾…Podåˆ›å»º... å½“å‰å·²åˆ›å»º: $TOTAL_PODS/$REPLICAS (${count}s)"
            fi
            
            sleep 1  # æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
            count=$((count + 1))
          done
          
          if [ "$all_pods_created" = false ]; then
            echo "  âŒ è¶…æ—¶ï¼šPodåˆ›å»ºæœªå®Œæˆï¼Œå½“å‰å·²åˆ›å»º: $TOTAL_PODS/$REPLICAS"
            FAILED_TESTS=$((FAILED_TESTS + 1))
            # æ¸…ç†å¤±è´¥çš„Deployment
            kubectl delete deployment $DEPLOYMENT_NAME -n $NAMESPACE --ignore-not-found=true
            continue
          fi
          


          
          # ğŸ¯ åŸºäºå­˜å‚¨æ•°æ®è¿›è¡Œæ²™ç®±å¤ç”¨æ£€æµ‹
          if [ -n "$CURRENT_TEST_POD_DATA" ]; then
            # æ£€æµ‹æ²™ç®±å¤ç”¨ï¼ˆåŸºäºæ²™ç®±åˆå§‹åŒ–æ—¶é—´ï¼‰
            CURRENT_REUSED_COUNT=0
            IFS='|' read -ra POD_ENTRIES <<< "$CURRENT_TEST_POD_DATA"
            for entry in "${POD_ENTRIES[@]}"; do
              IFS=':' read -ra POD_INFO <<< "$entry"
              if [ ${#POD_INFO[@]} -eq 4 ]; then
                SANDBOX_INIT="${POD_INFO[2]}"
                # æ£€æŸ¥æ²™ç®±åˆå§‹åŒ–æ—¶é—´æ˜¯å¦å°äº3ç§’
                REUSE_CHECK=$(python3 -c "print(float('$SANDBOX_INIT') < 3.0)" 2>/dev/null || echo "False")
                if [ "$REUSE_CHECK" = "True" ] && [ $i -eq 2 ]; then
                  CURRENT_REUSED_COUNT=$((CURRENT_REUSED_COUNT + 1))
                fi
              fi
            done
            
            if [ $CURRENT_REUSED_COUNT -gt 0 ]; then
              REUSED_SANDBOXES=$((REUSED_SANDBOXES + CURRENT_REUSED_COUNT))
              echo "  ğŸ¯ æ£€æµ‹åˆ° $CURRENT_REUSED_COUNT ä¸ªPodå¤ç”¨äº†æ²™ç®±"
            fi
          fi
          
          # è®°å½•æ¯æ¬¡æµ‹è¯•çš„å¹³å‡æ—¶é—´ç”¨äºå¯¹æ¯”
          if [ -z "$STARTUP_TIMES" ]; then
            STARTUP_TIMES="$pod_creation_time_sec"
          else
            STARTUP_TIMES="$STARTUP_TIMES $pod_creation_time_sec"
          fi
          
          # å­˜å‚¨å½“å‰æµ‹è¯•çš„æ•°æ®ç”¨äºæœ€ç»ˆç»Ÿè®¡
          if [ $i -eq 1 ]; then
            FIRST_TEST_DATA="$CURRENT_TEST_POD_DATA"
          else
            SECOND_TEST_DATA="$CURRENT_TEST_POD_DATA"
          fi
          
          # ç¬¬äºŒé˜¶æ®µï¼šç­‰å¾…Podå°±ç»ªéªŒè¯
          echo "  â³ ç­‰å¾…Podå°±ç»ªéªŒè¯..."
          ready_count=0
          while [ $ready_count -lt 60 ]; do  # æœ€å¤šç­‰å¾…60ç§’éªŒè¯
            READY_REPLICAS=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
            
            if [ "$READY_REPLICAS" = "$REPLICAS" ]; then
              echo "  âœ… æ‰€æœ‰Podå·²å°±ç»ªï¼ŒåŠŸèƒ½éªŒè¯é€šè¿‡"
              break
            fi
            
            if [ $((ready_count % 10)) -eq 0 ] && [ $ready_count -gt 0 ]; then
              echo "  â³ ç­‰å¾…Podå°±ç»ª... å½“å‰å°±ç»ª: $READY_REPLICAS/$REPLICAS (${ready_count}s)"
            fi
            
            sleep 1
            ready_count=$((ready_count + 1))
          done
          
          if [ "$READY_REPLICAS" != "$REPLICAS" ]; then
            echo "  âš ï¸ è­¦å‘Šï¼šéƒ¨åˆ†Podæœªå°±ç»ªï¼Œä½†Podåˆ›å»ºæµ‹è¯•å·²å®Œæˆ"
          fi
          
          echo "ğŸ“ˆ æµ‹è¯•ç»“æœ: åˆ›å»ºäº† $REPLICAS ä¸ªPodï¼Œè€—æ—¶ $pod_creation_time_sec ç§’"
          echo "ğŸ‰ ${TEST_TYPE}æˆåŠŸ"
          
          SUCCESSFUL_TESTS=$((SUCCESSFUL_TESTS + 1))
          
          # æ¸…ç†æµ‹è¯•èµ„æº
          echo "  ğŸ§¹ æ¸…ç†æµ‹è¯•èµ„æº..."
          kubectl delete deployment $DEPLOYMENT_NAME -n $NAMESPACE --ignore-not-found=true
          
          # ç­‰å¾…èµ„æºæ¸…ç†å®Œæˆ
          echo "  ğŸ§¹ ç­‰å¾…èµ„æºæ¸…ç†å®Œæˆ..."
          while [ $(kubectl get pods -n $NAMESPACE -l sandbox-reuse-test=true --ignore-not-found=true | wc -l) -gt 0 ]; do
            sleep 2
          done
          echo "  âœ… æ¸…ç†å®Œæˆ"
          
          # æ›´æ–°æœ€ç»ˆç»Ÿè®¡
          echo ""
          echo "========================================"
          echo "ğŸ“Š æµ‹è¯•å®Œæˆç»Ÿè®¡æ±‡æ€»"
          echo "========================================"
          echo "æµ‹è¯•æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "æµ‹è¯•èŠ‚ç‚¹: $node_name"
          echo "Podå‰¯æœ¬æ•°: $REPLICAS"
          echo "æ€»æµ‹è¯•æ¬¡æ•°: $ITERATIONS"
          echo "æˆåŠŸæµ‹è¯•: $SUCCESSFUL_TESTS"
          echo "å¤±è´¥æµ‹è¯•: $FAILED_TESTS"
          echo "æˆåŠŸç‡: ${SUCCESS_RATE}%"
          echo ""
          echo "ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡:"
          echo "  Podåˆ›å»ºè€—æ—¶: ${SANDBOX_INIT_AVG}.0ç§’"
          echo ""
          echo "ğŸ“ˆ è¯¦ç»†æ—¶é—´ç»Ÿè®¡:"
          echo "åŸºå‡†æµ‹è¯•: ${SANDBOX_INIT_AVG}.0ç§’"
          
          # æµ‹è¯•é—´éš”
          if [ $i -lt $ITERATIONS ]; then
            echo "  â³ ç­‰å¾… ${DELAY} åè¿›è¡Œä¸‹ä¸€æ¬¡æµ‹è¯•..."
            sleep ${DELAY}
          fi
          
        done
        
        # è®¡ç®—æ–°çš„å‡†ç¡®æ—¶é—´æŒ‡æ ‡ç»Ÿè®¡
        echo ""
        echo "ğŸ“Š å‡†ç¡®æ—¶é—´æŒ‡æ ‡ç»Ÿè®¡:"
        
        # æ²™ç®±åˆå§‹åŒ–è€—æ—¶ç»Ÿè®¡
        if [ -n "$SANDBOX_INIT_TIMES" ]; then
          SANDBOX_INIT_STATS=$(echo "$SANDBOX_INIT_TIMES" | awk '{
            sum = 0; min = $1; max = $1; count = NF
            for(i=1; i<=NF; i++) {
              sum += $i
              if($i < min) min = $i
              if($i > max) max = $i
            }
            avg = sum / count
            printf "%.1f %.1f %.1f", avg, min, max
          }')
          
          AVG_SANDBOX_INIT=$(echo "$SANDBOX_INIT_STATS" | awk '{print $1}')
          MIN_SANDBOX_INIT=$(echo "$SANDBOX_INIT_STATS" | awk '{print $2}')
          MAX_SANDBOX_INIT=$(echo "$SANDBOX_INIT_STATS" | awk '{print $3}')
          
          echo "  ğŸ“‹ æ²™ç®±åˆå§‹åŒ–è€—æ—¶ï¼ˆä¸å«è°ƒåº¦ç­‰å¾…ï¼‰:"
          echo "    å¹³å‡: ${AVG_SANDBOX_INIT}ç§’"
          echo "    æœ€å¿«: ${MIN_SANDBOX_INIT}ç§’"
          echo "    æœ€æ…¢: ${MAX_SANDBOX_INIT}ç§’"
        fi
        
        # ç«¯åˆ°ç«¯è€—æ—¶ç»Ÿè®¡
        if [ -n "$END_TO_END_TIMES" ]; then
          END_TO_END_STATS=$(echo "$END_TO_END_TIMES" | awk '{
            sum = 0; min = $1; max = $1; count = NF
            for(i=1; i<=NF; i++) {
              sum += $i
              if($i < min) min = $i
              if($i > max) max = $i
            }
            avg = sum / count
            printf "%.1f %.1f %.1f", avg, min, max
          }')
          
          AVG_END_TO_END=$(echo "$END_TO_END_STATS" | awk '{print $1}')
          MIN_END_TO_END=$(echo "$END_TO_END_STATS" | awk '{print $2}')
          MAX_END_TO_END=$(echo "$END_TO_END_STATS" | awk '{print $3}')
          
          echo "  ğŸ“‹ ç«¯åˆ°ç«¯è€—æ—¶ï¼ˆPodåˆ›å»ºâ†’PodReadyï¼‰:"
          echo "    å¹³å‡: ${AVG_END_TO_END}ç§’"
          echo "    æœ€å¿«: ${MIN_END_TO_END}ç§’"
          echo "    æœ€æ…¢: ${MAX_END_TO_END}ç§’"
        fi
        
        # è°ƒåº¦ç­‰å¾…è€—æ—¶ç»Ÿè®¡
        if [ -n "$SCHEDULING_WAIT_TIMES" ]; then
          SCHEDULING_WAIT_STATS=$(echo "$SCHEDULING_WAIT_TIMES" | awk '{
            sum = 0; min = $1; max = $1; count = NF
            for(i=1; i<=NF; i++) {
              sum += $i
              if($i < min) min = $i
              if($i > max) max = $i
            }
            avg = sum / count
            printf "%.1f %.1f %.1f", avg, min, max
          }')
          
          AVG_SCHEDULING_WAIT=$(echo "$SCHEDULING_WAIT_STATS" | awk '{print $1}')
          MIN_SCHEDULING_WAIT=$(echo "$SCHEDULING_WAIT_STATS" | awk '{print $2}')
          MAX_SCHEDULING_WAIT=$(echo "$SCHEDULING_WAIT_STATS" | awk '{print $3}')
          
          echo "  ğŸ“‹ è°ƒåº¦ç­‰å¾…è€—æ—¶ï¼ˆç«¯åˆ°ç«¯ - æ²™ç®±åˆå§‹åŒ–ï¼‰:"
          echo "    å¹³å‡: ${AVG_SCHEDULING_WAIT}ç§’"
          echo "    æœ€å¿«: ${MIN_SCHEDULING_WAIT}ç§’"
          echo "    æœ€æ…¢: ${MAX_SCHEDULING_WAIT}ç§’"
        fi
        
        # ä½¿ç”¨æ²™ç®±åˆå§‹åŒ–æ—¶é—´ä½œä¸ºä¸»è¦æŒ‡æ ‡
        if [ -n "$AVG_SANDBOX_INIT" ]; then
          echo ""
          echo "âœ… ä½¿ç”¨æ²™ç®±åˆå§‹åŒ–è€—æ—¶ï¼ˆPodåˆ›å»ºè€—æ—¶ï¼‰: ${AVG_SANDBOX_INIT}ç§’"
        fi
        
        # æ›´æ–°æœ€ç»ˆç»Ÿè®¡è¾“å‡º
        echo ""
        echo "========================================"
        echo "ğŸ“Š æµ‹è¯•å®Œæˆç»Ÿè®¡æ±‡æ€»"
        echo "========================================"
        echo "æµ‹è¯•æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "æµ‹è¯•èŠ‚ç‚¹: $node_name"
        echo "Podå‰¯æœ¬æ•°: $REPLICAS"
        echo "æ€»æµ‹è¯•æ¬¡æ•°: $TOTAL_TESTS"
        echo "æˆåŠŸæµ‹è¯•: $SUCCESSFUL_TESTS"
        echo "å¤±è´¥æµ‹è¯•: $FAILED_TESTS"
        
        if [ "$TOTAL_TESTS" -gt 0 ] 2>/dev/null; then
          SUCCESS_RATE=$((SUCCESSFUL_TESTS * 100 / TOTAL_TESTS))
          echo "æˆåŠŸç‡: ${SUCCESS_RATE}%"
        else
          echo "æˆåŠŸç‡: è®¡ç®—å¤±è´¥"
        fi
        
        echo ""
        echo "ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡:"
        echo "  å¹³å‡Podåˆ›å»ºè€—æ—¶: ${SANDBOX_INIT_AVG}.0ç§’"
        echo ""
        echo "ğŸ“ˆ è¯¦ç»†æ—¶é—´ç»Ÿè®¡ (Podåˆ›å»ºæ—¶é—´ï¼Œä¸å«å¯åŠ¨æ—¶é—´):"
        echo "åŸºå‡†æµ‹è¯•: ${SANDBOX_INIT_AVG}.0ç§’"
        
        # æ²™ç®±å¤ç”¨æ•ˆæœåˆ†æ
        if [ "$ITERATIONS" -eq 2 ]; then  # ä¸¤æ¬¡æµ‹è¯•
          FIRST_TIME=$(echo $STARTUP_TIMES | awk '{print $1}')
          SECOND_TIME=$(echo $STARTUP_TIMES | awk '{print $2}')
          
          echo ""
          echo "ğŸ”„ æ²™ç®±å¤ç”¨æ•ˆæœåˆ†æ:"
          echo "åŸºå‡†æµ‹è¯•ï¼ˆé¦–æ¬¡åˆ›å»ºæ²™ç®±ï¼‰: ${FIRST_TIME}ç§’"
          echo "æ²™ç®±å¤ç”¨æµ‹è¯•: ${SECOND_TIME}ç§’"
          
          # ä½¿ç”¨awkè¿›è¡Œæµ®ç‚¹æ•°æ¯”è¾ƒå’Œè®¡ç®—
          COMPARISON=$(echo "$FIRST_TIME $SECOND_TIME" | awk '{
            if ($1 > $2) {
              improvement = $1 - $2
              if ($1 > 0) {
                percent = int(improvement * 100 / $1)
              } else {
                percent = 0
              }
              printf "âš¡ æ€§èƒ½æå‡: %.1fç§’ (%d%%)", improvement, percent
            } else if ($1 < $2) {
              degradation = $2 - $1
              if ($1 > 0) {
                percent = int(degradation * 100 / $1)
              } else {
                percent = 0
              }
              printf "âš ï¸  æ€§èƒ½ä¸‹é™: %.1fç§’ (%d%%)", degradation, percent
            } else {
              printf "ğŸ“Š ä¸¤æ¬¡åˆ›å»ºæ—¶é—´ç›¸åŒ: %.1fç§’", $1
            }
          }')
          echo "$COMPARISON"
          
          # æ ¹æ®ç»“æœç»™å‡ºåˆ†æ
          ANALYSIS=$(echo "$FIRST_TIME $SECOND_TIME" | awk '{
            if ($1 > $2) {
              print "ğŸ“ æ²™ç®±å¤ç”¨ç”Ÿæ•ˆï¼Œæ€§èƒ½æœ‰æ‰€æå‡"
            } else if ($1 < $2) {
              print "ğŸ“ å¯èƒ½åŸå› : èŠ‚ç‚¹è´Ÿè½½ã€ç½‘ç»œå»¶è¿Ÿæˆ–æ²™ç®±å¤ç”¨æœªç”Ÿæ•ˆ"
            } else {
              print "ğŸ“ æ²™ç®±å¤ç”¨å¯èƒ½ç”Ÿæ•ˆï¼Œä½†æ€§èƒ½æå‡ä¸æ˜æ˜¾"
            }
          }')
          echo "$ANALYSIS"
        fi
        
        echo ""
        echo "æ¸…ç†æµ‹è¯•èµ„æº..."
        
        echo ""
        echo "========================================"
        echo "æ²™ç®±å¤ç”¨æµ‹è¯•å®Œæˆï¼"
        echo "========================================"
        
        if [ $FAILED_TESTS -eq 0 ]; then
          echo "æœ€ç»ˆç»“æœ: SUCCESS"
        else
          echo "æœ€ç»ˆç»“æœ: PARTIAL_SUCCESS"
        fi
        
        echo "å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "æµ‹è¯•èŠ‚ç‚¹: $node_name"
        echo "Podå‰¯æœ¬æ•°: $REPLICAS"
        
        # å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        echo "ğŸ” æ£€æŸ¥ä¼ä¸šå¾®ä¿¡é€šçŸ¥é…ç½®..."
        echo "Webhook URL: '$WEBHOOK_URL'"
        if [ -n "$WEBHOOK_URL" ] && [ "$WEBHOOK_URL" != "" ] && [ "$WEBHOOK_URL" != "YOUR_WEBHOOK_KEY" ]; then
          echo "ğŸ“¨ å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥..."
          
          # å‡†å¤‡é€šçŸ¥å‚æ•°
          if [ $FAILED_TESTS -eq 0 ]; then
            TEST_STATUS="SUCCESS"
          else
            TEST_STATUS="PARTIAL_FAILURE"
          fi
          
          # è®¡ç®—å¹³å‡æ—¶é—´
          AVERAGE_TIME="0"
          if [ -n "$AVG_SANDBOX_INIT" ]; then
            AVERAGE_TIME="$AVG_SANDBOX_INIT"
          fi
          
          # è·å–ç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡æµ‹è¯•æ—¶é—´
          FIRST_TIME="0"
          SECOND_TIME="0"
          if [ "$ITERATIONS" -eq 2 ] && [ -n "$STARTUP_TIMES" ]; then
            FIRST_TIME=$(echo "$STARTUP_TIMES" | awk '{print $1}' 2>/dev/null || echo "0")
            SECOND_TIME=$(echo "$STARTUP_TIMES" | awk '{print $2}' 2>/dev/null || echo "0")
          fi
          
          # è·å–ç»Ÿè®¡æ•°æ®ï¼ˆæœ€å¿«ã€æœ€æ…¢æ—¶é—´ï¼‰
          MIN_TIME="0"
          MAX_TIME="0"
          if [ -n "$MIN_SANDBOX_INIT" ]; then
            MIN_TIME="$MIN_SANDBOX_INIT"
          fi
          if [ -n "$MAX_SANDBOX_INIT" ]; then
            MAX_TIME="$MAX_SANDBOX_INIT"
          fi
          
          # è®¡ç®—æ²™ç®±å¤ç”¨è¦†ç›–ç‡
          REUSE_COVERAGE="0%"
          if [ "$ITERATIONS" -eq 2 ] && [ "$REPLICAS" -gt 0 ]; then
            REUSE_PERCENTAGE=$((REUSED_SANDBOXES * 100 / REPLICAS))
            REUSE_COVERAGE="${REUSE_PERCENTAGE}%"
          fi
          
          # ä½¿ç”¨æ¨¡æ¿å‘é€é€šçŸ¥
          echo "  ğŸ“Š é€šçŸ¥å‚æ•°:"
          echo "    çŠ¶æ€: $TEST_STATUS"
          echo "    å¹³å‡æ—¶é—´: $AVERAGE_TIME"
          echo "    ç¬¬ä¸€æ¬¡: $FIRST_TIME"
          echo "    ç¬¬äºŒæ¬¡: $SECOND_TIME"
          echo "    æœ€å¿«æ—¶é—´: $MIN_TIME"
          echo "    æœ€æ…¢æ—¶é—´: $MAX_TIME"
          
          # è¿™é‡Œåº”è¯¥è°ƒç”¨sandbox-wechat-notify-template
          # ä½†ç”±äºè¿™æ˜¯è„šæœ¬æ¨¡æ¿ï¼Œæˆ‘ä»¬éœ€è¦ç›´æ¥æ„å»ºæ¶ˆæ¯
          
          # æ„å»ºç¬¦åˆæ–°æ ¼å¼çš„é€šçŸ¥æ¶ˆæ¯
          NOTIFICATION_MESSAGE=$(cat <<EOF
        {
        "msgtype": "markdown",
        "markdown": {
        "content": "âœ… è¶…çº§èŠ‚ç‚¹æ²™ç®±å¤ç”¨æµ‹è¯•å®Œæˆ\\n\\nğŸ“‹ åŸºç¡€ä¿¡æ¯\\n- é›†ç¾¤ID: \`$CLUSTER_ID\`\\n- å®Œæˆæ—¶é—´: \`$(date '+%Y-%m-%d %H:%M:%S')\`\\n- æµ‹è¯•èŠ‚ç‚¹: \`$node_name\`\\n- Podå‰¯æœ¬æ•°: $REPLICASä¸ª\\n\\nğŸ“Š æµ‹è¯•ç»“æœ\\n- çŠ¶æ€: $([ "$TEST_STATUS" = "SUCCESS" ] && echo "å…¨éƒ¨æˆåŠŸ" || echo "éƒ¨åˆ†å¤±è´¥")\\n- æ€»æµ‹è¯•: $TOTAL_TESTSæ¬¡\\n- æˆåŠŸ: $SUCCESSFUL_TESTSæ¬¡\\n- å¤±è´¥: $FAILED_TESTSæ¬¡\\n\\nğŸ“‹ Podåˆ›å»ºæ—¶é—´ï¼ˆä¸å«å¯åŠ¨æ—¶é—´ï¼‰:\\n- åŸºå‡†æµ‹è¯•å¹³å‡: $FIRST_TIMEç§’\\n- æ²™ç®±å¤ç”¨å¹³å‡: $SECOND_TIMEç§’\\n- æ€§èƒ½æå‡: $(echo \"$FIRST_TIME $SECOND_TIME\" | awk '{if($1>0 && $2>=0) printf \"%.1f%%\", ($1-$2)*100/$1; else print \"è®¡ç®—ä¸­\"}')\\n\\nğŸ“Š æ²™ç®±å¤ç”¨æ•ˆæœåˆ†æ:\\n- åŸºå‡†æµ‹è¯•ï¼ˆé¦–æ¬¡åˆ›å»ºï¼‰: $FIRST_TIMEç§’\\n- æ²™ç®±å¤ç”¨æµ‹è¯•: $SECOND_TIMEç§’\\n- æ²™ç®±å¤ç”¨è¦†ç›–ç‡: $REUSE_COVERAGE ($REUSED_SANDBOXES/$REPLICASä¸ªPod)\\n- ç»“è®º: $(echo \"$FIRST_TIME $SECOND_TIME\" | awk '{if($1>$2 && $1>0) print \"æ²™ç®±å¤ç”¨ç”Ÿæ•ˆï¼Œæ€§èƒ½æå‡æ˜æ˜¾\"; else if($1==$2) print \"ä¸¤æ¬¡æ—¶é—´ç›¸åŒï¼Œæ²™ç®±å¤ç”¨å¯èƒ½ç”Ÿæ•ˆ\"; else print \"éœ€è¦è¿›ä¸€æ­¥åˆ†æ\"}')\\n\\nğŸ“ˆ è¯¦ç»†åˆ†ææ•°æ®è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—"
        }
        }
        EOF
          )
          
          # å‘é€é€šçŸ¥
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d "$NOTIFICATION_MESSAGE" \
            "$WEBHOOK_URL")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "  âœ… ä¼ä¸šå¾®ä¿¡é€šçŸ¥å‘é€æˆåŠŸ"
          else
            echo "  âŒ ä¼ä¸šå¾®ä¿¡é€šçŸ¥å‘é€å¤±è´¥"
            echo "  HTTPçŠ¶æ€ç : $HTTP_CODE"
            echo "  å“åº”: $RESPONSE_BODY"
          fi
        else
          echo "  â„¹ï¸  æœªé…ç½®ä¼ä¸šå¾®ä¿¡é€šçŸ¥æˆ–é…ç½®æ— æ•ˆ"
        fi
        
        # æ ¹æ®æµ‹è¯•ç»“æœå†³å®šé€€å‡ºçŠ¶æ€
        if [ $FAILED_TESTS -eq 0 ]; then
          echo "success" > /tmp/result
          echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•éƒ½æˆåŠŸå®Œæˆï¼"
        else
          echo "partial_failure" > /tmp/result
          echo "âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi
    outputs:
      parameters:
      - name: result
        valueFrom:
          path: /tmp/result