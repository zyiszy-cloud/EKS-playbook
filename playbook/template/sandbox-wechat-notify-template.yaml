---
# åŠŸèƒ½è¯´æ˜: æ²™ç®±å¤ç”¨æµ‹è¯•ä¼å¾®ç¾¤é€šçŸ¥æ¨¡ç‰ˆ
# generate-sandbox-test-notify-message: ç”Ÿæˆæ²™ç®±æµ‹è¯•Markdownæ¶ˆæ¯
# generate-sandbox-test-message-then-notify: ç”Ÿæˆæ¶ˆæ¯å¹¶å‘é€åˆ°ä¼å¾®ç¾¤
# notify: å‘é€Markdownæ¶ˆæ¯åˆ°ä¼å¾®ç¾¤
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: sandbox-wechat-notify-template
  annotations:
    description: "è¶…çº§èŠ‚ç‚¹æ²™ç®±å¤ç”¨æµ‹è¯•ä¼ä¸šå¾®ä¿¡é€šçŸ¥æ¨¡æ¿"
    version: "1.0"
spec:
  entrypoint: notify
  templates:
  
  # ç”Ÿæˆæ¶ˆæ¯å¹¶å‘é€çš„ç»„åˆæ¨¡æ¿
  - name: generate-sandbox-test-message-then-notify
    inputs:
      parameters:
      # åŸºç¡€ä¿¡æ¯å‚æ•°
      - name: stage
        description: "æµ‹è¯•é˜¶æ®µ (å¼€å§‹/å®Œæˆ/å¤±è´¥)"
      - name: cluster-id
        description: "é›†ç¾¤ID"
      - name: test-node
        description: "æµ‹è¯•èŠ‚ç‚¹åç§°"
        default: "unknown"
      - name: pod-replicas
        description: "Podå‰¯æœ¬æ•°"
        default: "1"
      
      # æµ‹è¯•ç»“æœå‚æ•°
      - name: test-status
        description: "æµ‹è¯•çŠ¶æ€ (SUCCESS/PARTIAL_FAILURE/FAILURE)"
        default: "UNKNOWN"
      - name: total-tests
        description: "æ€»æµ‹è¯•æ¬¡æ•°"
        default: "0"
      - name: successful-tests
        description: "æˆåŠŸæµ‹è¯•æ¬¡æ•°"
        default: "0"
      - name: failed-tests
        description: "å¤±è´¥æµ‹è¯•æ¬¡æ•°"
        default: "0"
      - name: average-time
        description: "å¹³å‡åˆ›å»ºæ—¶é—´(ç§’)"
        default: "0"
      
      # æ€§èƒ½åˆ†æå‚æ•°
      - name: first-time
        description: "é¦–æ¬¡åˆ›å»ºæ—¶é—´(ç§’)"
        default: "0"
      - name: second-time
        description: "æ²™ç®±å¤ç”¨æ—¶é—´(ç§’)"
        default: "0"
      - name: improvement
        description: "æ€§èƒ½æå‡(ç§’)"
        default: "0"
      - name: improvement-percent
        description: "æ€§èƒ½æå‡ç™¾åˆ†æ¯”"
        default: "0"
      
      # è¯¦ç»†ä¿¡æ¯å‚æ•°
      - name: details-message
        description: "è¯¦ç»†ä¿¡æ¯æˆ–é”™è¯¯ä¿¡æ¯"
        default: ""
      
      # é€šçŸ¥å‚æ•°
      - name: webhook-url
        description: "ä¼ä¸šå¾®ä¿¡webhookåœ°å€"
    
    steps:
    - - name: generate-sandbox-test-notify-message
        template: generate-sandbox-test-notify-message
        arguments:
          parameters:
          - name: stage
            value: "{{inputs.parameters.stage}}"
          - name: cluster-id
            value: "{{inputs.parameters.cluster-id}}"
          - name: test-node
            value: "{{inputs.parameters.test-node}}"
          - name: pod-replicas
            value: "{{inputs.parameters.pod-replicas}}"
          - name: test-status
            value: "{{inputs.parameters.test-status}}"
          - name: total-tests
            value: "{{inputs.parameters.total-tests}}"
          - name: successful-tests
            value: "{{inputs.parameters.successful-tests}}"
          - name: failed-tests
            value: "{{inputs.parameters.failed-tests}}"
          - name: average-time
            value: "{{inputs.parameters.average-time}}"
          - name: first-time
            value: "{{inputs.parameters.first-time}}"
          - name: second-time
            value: "{{inputs.parameters.second-time}}"
          - name: improvement
            value: "{{inputs.parameters.improvement}}"
          - name: improvement-percent
            value: "{{inputs.parameters.improvement-percent}}"
          - name: details-message
            value: "{{inputs.parameters.details-message}}"
    
    - - name: notify-sandbox-test-to-wechat
        template: notify
        arguments:
          parameters:
          - name: message
            value: |
              {
                "msgtype": "markdown",
                "markdown": {
                  "content": "{{steps.generate-sandbox-test-notify-message.outputs.parameters.result}}"
                }
              }
          - name: webhook-url
            value: "{{inputs.parameters.webhook-url}}"

  # ç”Ÿæˆæ²™ç®±æµ‹è¯•é€šçŸ¥æ¶ˆæ¯æ¨¡æ¿
  - name: generate-sandbox-test-notify-message
    inputs:
      parameters:
      - name: stage
        description: "æµ‹è¯•é˜¶æ®µ"
      - name: cluster-id
        description: "é›†ç¾¤ID"
      - name: test-node
        description: "æµ‹è¯•èŠ‚ç‚¹åç§°"
        default: "unknown"
      - name: pod-replicas
        description: "Podå‰¯æœ¬æ•°"
        default: "1"
      - name: test-status
        description: "æµ‹è¯•çŠ¶æ€"
        default: "UNKNOWN"
      - name: total-tests
        description: "æ€»æµ‹è¯•æ¬¡æ•°"
        default: "0"
      - name: successful-tests
        description: "æˆåŠŸæµ‹è¯•æ¬¡æ•°"
        default: "0"
      - name: failed-tests
        description: "å¤±è´¥æµ‹è¯•æ¬¡æ•°"
        default: "0"
      - name: average-time
        description: "å¹³å‡åˆ›å»ºæ—¶é—´(ç§’)"
        default: "0"
      - name: first-time
        description: "é¦–æ¬¡åˆ›å»ºæ—¶é—´(ç§’)"
        default: "0"
      - name: second-time
        description: "æ²™ç®±å¤ç”¨æ—¶é—´(ç§’)"
        default: "0"
      - name: improvement
        description: "æ€§èƒ½æå‡(ç§’)"
        default: "0"
      - name: improvement-percent
        description: "æ€§èƒ½æå‡ç™¾åˆ†æ¯”"
        default: "0"
      - name: details-message
        description: "è¯¦ç»†ä¿¡æ¯"
        default: ""
    
    script:
      image: busybox:1.37.0
      command: [sh]
      source: |
        # æ ¹æ®æµ‹è¯•çŠ¶æ€è®¾ç½®emojiå’Œé¢œè‰²
        case "{{inputs.parameters.test-status}}" in
          "SUCCESS")
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="å…¨éƒ¨æˆåŠŸ"
            ;;
          "PARTIAL_FAILURE")
            STATUS_EMOJI="âš ï¸"
            STATUS_TEXT="éƒ¨åˆ†å¤±è´¥"
            ;;
          "FAILURE")
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="æµ‹è¯•å¤±è´¥"
            ;;
          *)
            STATUS_EMOJI="ğŸ“Š"
            STATUS_TEXT="{{inputs.parameters.stage}}"
            ;;
        esac
        
        # æ ¹æ®é˜¶æ®µç”Ÿæˆä¸åŒçš„æ¶ˆæ¯å†…å®¹
        if [ "{{inputs.parameters.stage}}" = "å¼€å§‹" ]; then
          cat <<EOF > /tmp/result
        ### ${STATUS_EMOJI} è¶…çº§èŠ‚ç‚¹æ²™ç®±å¤ç”¨æµ‹è¯•å¼€å§‹
        
        **ğŸ“‹ åŸºç¡€ä¿¡æ¯**
        - é›†ç¾¤ID: \`{{inputs.parameters.cluster-id}}\`
        - æµ‹è¯•èŠ‚ç‚¹: \`{{inputs.parameters.test-node}}\`
        - Podå‰¯æœ¬æ•°: **{{inputs.parameters.pod-replicas}}ä¸ª**
        - å¼€å§‹æ—¶é—´: \`$(date '+%Y-%m-%d %H:%M:%S')\`
        
        **ğŸš€ æµ‹è¯•é…ç½®**
        - æµ‹è¯•ç±»å‹: æ²™ç®±å¤ç”¨æ€§èƒ½æµ‹è¯•
        - æµ‹è¯•ç­–ç•¥: åŸºå‡†æµ‹è¯• vs æ²™ç®±å¤ç”¨æµ‹è¯•
        - é¢„è®¡è€—æ—¶: çº¦2-5åˆ†é’Ÿ
        
        > ğŸ“Š æµ‹è¯•è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...
        EOF
        else
          # ç”Ÿæˆæ—¶é—´æŒ‡æ ‡ç»Ÿè®¡éƒ¨åˆ†
          TIME_METRICS_SECTION=""
          if [ "{{inputs.parameters.average-time}}" != "0" ] && [ "{{inputs.parameters.average-time}}" != "" ]; then
            TIME_METRICS_SECTION="
        **ğŸ“‹ Podåˆ›å»ºè€—æ—¶ï¼ˆæ²™ç®±åˆå§‹åŒ–ï¼‰:**
        - å¹³å‡: {{inputs.parameters.average-time}}ç§’
        - æœ€å¿«: {{inputs.parameters.first-time}}ç§’
        - æœ€æ…¢: {{inputs.parameters.second-time}}ç§’"
          fi
          
          # ç”Ÿæˆæ²™ç®±å¤ç”¨æ•ˆæœåˆ†æéƒ¨åˆ†
          REUSE_ANALYSIS_SECTION=""
          if [ "{{inputs.parameters.first-time}}" != "0" ] && [ "{{inputs.parameters.second-time}}" != "0" ]; then
            # è®¡ç®—æ€§èƒ½æå‡
            IMPROVEMENT=$(echo "{{inputs.parameters.first-time}} {{inputs.parameters.second-time}}" | awk '{
              if ($1 > $2) {
                improvement = $1 - $2
                if ($1 > 0) {
                  percent = int(improvement * 100 / $1)
                } else {
                  percent = 0
                }
                printf "%.1f", improvement
              } else {
                printf "0.0"
              }
            }')
            
            # ç”Ÿæˆç»“è®º
            CONCLUSION=""
            if [ "$IMPROVEMENT" != "0.0" ]; then
              CONCLUSION="æ€§èƒ½æå‡æ˜æ˜¾ï¼Œæ²™ç®±å¤ç”¨ç”Ÿæ•ˆ"
            else
              CONCLUSION="ä¸¤æ¬¡åˆ›å»ºæ—¶é—´ç›¸åŒï¼Œæ²™ç®±å¤ç”¨å¯èƒ½ç”Ÿæ•ˆä½†æå‡ä¸æ˜æ˜¾"
            fi
            
            REUSE_ANALYSIS_SECTION="
        **ğŸ“Š æ²™ç®±å¤ç”¨æ•ˆæœåˆ†æ:**
        - åŸºå‡†æµ‹è¯•: {{inputs.parameters.first-time}}ç§’
        - æ²™ç®±å¤ç”¨: {{inputs.parameters.second-time}}ç§’
        - ç»“è®º: $CONCLUSION"
          fi
          
          # ç”Ÿæˆè¯¦ç»†ä¿¡æ¯éƒ¨åˆ†
          DETAILS_SECTION=""
          if [ "{{inputs.parameters.details-message}}" != "" ] && [ "{{inputs.parameters.details-message}}" != "N/A" ]; then
            DETAILS_SECTION="
        **ğŸ“ è¯¦ç»†ä¿¡æ¯**
        {{inputs.parameters.details-message}}"
          fi
          
          cat <<EOF >> /tmp/result
        ### ${STATUS_EMOJI} è¶…çº§èŠ‚ç‚¹æ²™ç®±å¤ç”¨æµ‹è¯•å®Œæˆ
        
        **ğŸ“‹ åŸºç¡€ä¿¡æ¯**
        - é›†ç¾¤ID: \`{{inputs.parameters.cluster-id}}\`
        - å®Œæˆæ—¶é—´: \`$(date '+%Y-%m-%d %H:%M:%S')\`
        - æµ‹è¯•èŠ‚ç‚¹: \`{{inputs.parameters.test-node}}\`
        - Podå‰¯æœ¬æ•°: **{{inputs.parameters.pod-replicas}}ä¸ª**
        
        **ğŸ“Š æµ‹è¯•ç»“æœ**
        - çŠ¶æ€: **${STATUS_TEXT}**
        - æ€»æµ‹è¯•: **{{inputs.parameters.total-tests}}æ¬¡**
        - æˆåŠŸ: **{{inputs.parameters.successful-tests}}æ¬¡**
        - å¤±è´¥: **{{inputs.parameters.failed-tests}}æ¬¡**${TIME_METRICS_SECTION}${REUSE_ANALYSIS_SECTION}${DETAILS_SECTION}
        
        > ğŸ“ˆ è¯¦ç»†åˆ†ææ•°æ®è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—
        EOF
        fi
    outputs:
      parameters:
      - name: result
        valueFrom:
          path: /tmp/result

  # é€šç”¨é€šçŸ¥å‘é€æ¨¡æ¿
  - name: notify
    retryStrategy:
      limit: "3"
      retryPolicy: "Always"
      backoff:
        duration: "5s"
        factor: 2
        maxDuration: "1m"
    inputs:
      parameters:
      - name: message
        description: "è¦å‘é€çš„æ¶ˆæ¯å†…å®¹(JSONæ ¼å¼)"
      - name: webhook-url
        description: "ä¼ä¸šå¾®ä¿¡webhookåœ°å€"
    
    script:
      image: curlimages/curl:8.5.0
      command: [sh]
      source: |
        echo "ğŸ“¨ å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥..."
        echo "Webhook URL: {{inputs.parameters.webhook-url}}"
        
        # å‘é€é€šçŸ¥
        RESPONSE=$(curl -s -w "%{http_code}" -X POST "{{inputs.parameters.webhook-url}}" \
          -H "Content-Type: application/json" \
          -d '{{inputs.parameters.message}}')
        
        # æå–HTTPçŠ¶æ€ç å’Œå“åº”ä½“
        HTTP_CODE="${RESPONSE: -3}"
        RESPONSE_BODY="${RESPONSE%???}"
        
        echo "HTTPçŠ¶æ€ç : $HTTP_CODE"
        echo "å“åº”å†…å®¹: $RESPONSE_BODY"
        
        # æ£€æŸ¥å‘é€ç»“æœ
        if [ "$HTTP_CODE" = "200" ]; then
          if echo "$RESPONSE_BODY" | grep -q '"errcode":0'; then
            echo "âœ… ä¼ä¸šå¾®ä¿¡é€šçŸ¥å‘é€æˆåŠŸ"
            exit 0
          else
            echo "âš ï¸ ä¼ä¸šå¾®ä¿¡APIè¿”å›é”™è¯¯: $RESPONSE_BODY"
            exit 1
          fi
        else
          echo "âŒ HTTPè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
          echo "å“åº”å†…å®¹: $RESPONSE_BODY"
          exit 1
        fi

  # ç®€åŒ–çš„é€šçŸ¥æ¨¡æ¿ï¼ˆåªå‘é€æ¶ˆæ¯ï¼Œä¸ç”Ÿæˆï¼‰
  - name: simple-notify
    inputs:
      parameters:
      - name: title
        description: "é€šçŸ¥æ ‡é¢˜"
      - name: content
        description: "é€šçŸ¥å†…å®¹"
      - name: webhook-url
        description: "ä¼ä¸šå¾®ä¿¡webhookåœ°å€"
    
    steps:
    - - name: send-simple-message
        template: notify
        arguments:
          parameters:
          - name: message
            value: |
              {
                "msgtype": "markdown",
                "markdown": {
                  "content": "### {{inputs.parameters.title}}\\n\\n{{inputs.parameters.content}}\\n\\n> å‘é€æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
                }
              }
          - name: webhook-url
            value: "{{inputs.parameters.webhook-url}}"