apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: supernode-sandbox-deployment-template
  annotations:
    description: "è¶…çº§èŠ‚ç‚¹Deploymentæ²™ç®±å¤ç”¨æµ‹è¯•æ¨¡æ¿ - æ¸…æ´ç‰ˆæœ¬"
    version: "4.0"
spec:
  serviceAccountName: tke-chaos
  entrypoint: deployment-sandbox-test
  
  arguments:
    parameters:
    - name: cluster-id
      value: "tke-cluster"
    - name: webhook-url
      value: ""
    - name: kubeconfig-secret-name
      value: ""
    - name: namespace
      value: "tke-chaos-test"
    - name: deployment-name-prefix
      value: "sandbox-deployment-test"
    - name: replicas
      value: "1"
    - name: pod-image
      value: "nginx:alpine"
    - name: cpu-request
      value: "100m"
    - name: memory-request
      value: "128Mi"
    - name: cpu-limit
      value: "200m"
    - name: memory-limit
      value: "256Mi"
    - name: test-iterations
      value: "1"
    - name: delay-between-tests
      value: "20s"

  templates:
  - name: deployment-sandbox-test
    inputs:
      parameters:
      - name: cluster-id
      - name: webhook-url
      - name: kubeconfig-secret-name
      - name: namespace
      - name: deployment-name-prefix
      - name: replicas
      - name: cpu-request
      - name: memory-request
      - name: cpu-limit
      - name: memory-limit
      - name: test-iterations
      - name: delay-between-tests
      - name: pod-image
    steps:
    - - name: verify-supernodes
        template: verify-supernodes
        arguments:
          parameters:
          - name: cluster-id
            value: "{{inputs.parameters.cluster-id}}"
          - name: kubeconfig-secret-name
            value: "{{inputs.parameters.kubeconfig-secret-name}}"
          - name: namespace
            value: "{{inputs.parameters.namespace}}"
    - - name: send-start-notification
        template: send-wechat-notification
        arguments:
          parameters:
          - name: stage
            value: "å¼€å§‹"
          - name: cluster-id
            value: "{{inputs.parameters.cluster-id}}"
          - name: pod-replicas
            value: "{{inputs.parameters.replicas}}"
          - name: webhook-url
            value: "{{inputs.parameters.webhook-url}}"
    - - name: run-deployment-test
        template: run-deployment-test
        arguments:
          parameters:
          - name: cluster-id
            value: "{{inputs.parameters.cluster-id}}"
          - name: webhook-url
            value: "{{inputs.parameters.webhook-url}}"
          - name: kubeconfig-secret-name
            value: "{{inputs.parameters.kubeconfig-secret-name}}"
          - name: namespace
            value: "{{inputs.parameters.namespace}}"
          - name: deployment-name-prefix
            value: "{{inputs.parameters.deployment-name-prefix}}"
          - name: replicas
            value: "{{inputs.parameters.replicas}}"
          - name: cpu-request
            value: "{{inputs.parameters.cpu-request}}"
          - name: memory-request
            value: "{{inputs.parameters.memory-request}}"
          - name: cpu-limit
            value: "{{inputs.parameters.cpu-limit}}"
          - name: memory-limit
            value: "{{inputs.parameters.memory-limit}}"
          - name: test-iterations
            value: "{{inputs.parameters.test-iterations}}"
          - name: delay-between-tests
            value: "{{inputs.parameters.delay-between-tests}}"
          - name: pod-image
            value: "{{inputs.parameters.pod-image}}"
    - - name: send-completion-notification
        template: send-wechat-notification
        arguments:
          parameters:
          - name: stage
            value: "å®Œæˆ"
          - name: cluster-id
            value: "{{inputs.parameters.cluster-id}}"
          - name: pod-replicas
            value: "{{inputs.parameters.replicas}}"
          - name: test-status
            value: "{{steps.run-deployment-test.outputs.result}}"
          - name: webhook-url
            value: "{{inputs.parameters.webhook-url}}"

  - name: verify-supernodes
    inputs:
      parameters:
      - name: cluster-id
      - name: kubeconfig-secret-name
      - name: namespace
    script:
      image: bitnami/kubectl:1.32.4
      command: [bash]
      source: |
        #!/bin/bash
        set -e
        
        echo "ğŸ” éªŒè¯è¶…çº§èŠ‚ç‚¹çŠ¶æ€..."
        SUPERNODES=$(kubectl get nodes --selector=node.kubernetes.io/instance-type=eklet -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
        
        if [ -z "$SUPERNODES" ]; then
          echo "âŒ æœªæ‰¾åˆ°è¶…çº§èŠ‚ç‚¹"
          echo "é”™è¯¯: æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è¶…çº§èŠ‚ç‚¹"
          echo "é€‰æ‹©å™¨: node.kubernetes.io/instance-type=eklet"
          echo "æ‰€æœ‰èŠ‚ç‚¹åˆ—è¡¨:"
          kubectl get nodes -o wide 2>/dev/null || echo "æ— æ³•è·å–èŠ‚ç‚¹åˆ—è¡¨"
          exit 1
        fi
        
        SUPERNODE_COUNT=$(echo $SUPERNODES | wc -w)
        echo "âœ… å‘ç° $SUPERNODE_COUNT ä¸ªè¶…çº§èŠ‚ç‚¹:"
        for node in $SUPERNODES; do
          echo "  - $node"
        done
        
        # æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
        for node in $SUPERNODES; do
          STATUS=$(kubectl get node $node -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}')
          if [ "$STATUS" != "True" ]; then
            echo "âŒ è¶…çº§èŠ‚ç‚¹ $node çŠ¶æ€å¼‚å¸¸: $STATUS"
            exit 1
          fi
          echo "  âœ… $node çŠ¶æ€æ­£å¸¸"
        done
        
        echo "success" > /tmp/result
      outputs:
        parameters:
        - name: result
          valueFrom:
            path: /tmp/result

  - name: run-deployment-test
    inputs:
      parameters:
      - name: cluster-id
      - name: webhook-url
      - name: kubeconfig-secret-name
      - name: namespace
      - name: deployment-name-prefix
      - name: replicas
      - name: cpu-request
      - name: memory-request
      - name: cpu-limit
      - name: memory-limit
      - name: test-iterations
      - name: delay-between-tests
      - name: pod-image
    script:
      image: bitnami/kubectl:1.32.4
      command: [bash]
      source: |
        #!/bin/bash
        
        # ä½¿ç”¨å†…ç½®shellè®¡ç®—ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–
        echo "ğŸ“Š ä½¿ç”¨å†…ç½®shellè®¡ç®—ï¼Œç§’çº§ç²¾åº¦"
        
        # æµ‹è¯•å‚æ•°åˆå§‹åŒ–
        CLUSTER_ID="{{inputs.parameters.cluster-id}}"
        WEBHOOK_URL="{{inputs.parameters.webhook-url}}"
        NAMESPACE="{{inputs.parameters.namespace}}"
        DEPLOYMENT_NAME_PREFIX="{{inputs.parameters.deployment-name-prefix}}"
        REPLICAS={{inputs.parameters.replicas}}
        POD_IMAGE="{{inputs.parameters.pod-image}}"
        CPU_REQUEST="{{inputs.parameters.cpu-request}}"
        MEMORY_REQUEST="{{inputs.parameters.memory-request}}"
        CPU_LIMIT="{{inputs.parameters.cpu-limit}}"
        MEMORY_LIMIT="{{inputs.parameters.memory-limit}}"
        ITERATIONS={{inputs.parameters.test-iterations}}
        DELAY="{{inputs.parameters.delay-between-tests}}"
        TIMEOUT="300s"
        
        # è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºæ¥æ”¶åˆ°çš„å‚æ•°
        echo "ğŸ” æ¥æ”¶åˆ°çš„æµ‹è¯•å‚æ•°:"
        echo "  é›†ç¾¤ID: $CLUSTER_ID"
        echo "  Webhook URL: '$WEBHOOK_URL'"
        echo "  å‘½åç©ºé—´: $NAMESPACE"
        echo "  Podå‰¯æœ¬æ•°: $REPLICAS"
        echo "  Podé•œåƒ: $POD_IMAGE"
        echo "  æµ‹è¯•è¿­ä»£: $ITERATIONS"
        echo "  é”€æ¯é—´éš”: $DELAY"
        echo ""
        
        # éªŒè¯å…³é”®å‚æ•°
        if [ "$REPLICAS" -eq 0 ] 2>/dev/null; then
          echo "âŒ é”™è¯¯ï¼šPodå‰¯æœ¬æ•°ä¸º0ï¼Œä½¿ç”¨é»˜è®¤å€¼1"
          REPLICAS=1
        fi
        
        echo "ğŸ“Š æœ€ç»ˆä½¿ç”¨çš„Podå‰¯æœ¬æ•°: $REPLICAS"
        
        # åˆå§‹åŒ–ç»Ÿè®¡å˜é‡
        TOTAL_TESTS=0
        SUCCESSFUL_TESTS=0
        FAILED_TESTS=0
        STARTUP_TIMES=""
        
        echo "========================================"
        echo "è¶…çº§èŠ‚ç‚¹Deploymentæ²™ç®±å¤ç”¨æ€§èƒ½æµ‹è¯•"
        echo "========================================"
        echo "é›†ç¾¤ID: $CLUSTER_ID"
        echo "æµ‹è¯•è¿­ä»£: $ITERATIONS æ¬¡"
        echo "Podå‰¯æœ¬æ•°: $REPLICAS ä¸ª"
        echo "å‘½åç©ºé—´: $NAMESPACE"
        echo "Podé•œåƒ: $POD_IMAGE"
        echo "èµ„æºé™åˆ¶: CPU=$CPU_LIMIT, Memory=$MEMORY_LIMIT"
        echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "========================================"
        
        # è·å–è¶…çº§èŠ‚ç‚¹ä¿¡æ¯
        echo "ğŸ” è·å–è¶…çº§èŠ‚ç‚¹ä¿¡æ¯..."
        SUPERNODES=$(kubectl get nodes --selector=node.kubernetes.io/instance-type=eklet -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
        if [ -z "$SUPERNODES" ]; then
          echo "âŒ é”™è¯¯: æ— æ³•è·å–è¶…çº§èŠ‚ç‚¹ä¿¡æ¯"
          echo "è¯·æ£€æŸ¥é›†ç¾¤è¿æ¥å’ŒèŠ‚ç‚¹æ ‡ç­¾"
          echo "failure" > /tmp/result
          exit 1
        fi
        
        SUPERNODE_COUNT=$(echo $SUPERNODES | wc -w)
        echo "ğŸ“Š è¶…çº§èŠ‚ç‚¹ä¿¡æ¯:"
        echo "  èŠ‚ç‚¹æ•°é‡: $SUPERNODE_COUNT"
        for node in $SUPERNODES; do
          echo "  - $node"
        done
        
        # æ²™ç®±å¤ç”¨æµ‹è¯•é€»è¾‘
        DEPLOYMENT_NAME="${DEPLOYMENT_NAME_PREFIX}-sandbox-reuse-test"
        node_name=$(echo $SUPERNODES | awk '{print $1}')
        echo "ğŸ¯ é€‰æ‹©æµ‹è¯•èŠ‚ç‚¹: $node_name"
        echo "ğŸ“‹ æµ‹è¯•ç­–ç•¥: ä¸¤æ¬¡Podåˆ›å»ºå¯¹æ¯”æµ‹è¯•ï¼ˆåŸºå‡†æµ‹è¯• vs æ²™ç®±å¤ç”¨æµ‹è¯•ï¼‰"
        echo "â±ï¸  é”€æ¯é—´éš”: ${DELAY} (20ç§’åé”€æ¯Pod)"
        echo ""
        
        # æ‰§è¡Œä¸¤æ¬¡Podåˆ›å»ºå¯¹æ¯”æµ‹è¯•
        for i in $(seq 1 2); do
          if [ $i -eq 1 ]; then
            echo "========================================"
            echo "ç¬¬1æ¬¡æµ‹è¯•ï¼šåŸºå‡†æµ‹è¯•ï¼ˆé¦–æ¬¡åˆ›å»ºæ²™ç®±ï¼‰"
            echo "========================================"
          else
            echo "========================================"
            echo "ç¬¬2æ¬¡æµ‹è¯•ï¼šæ²™ç®±å¤ç”¨æµ‹è¯•"
            echo "========================================"
          fi
          
          TOTAL_TESTS=$((TOTAL_TESTS + 1))
          if [ $i -eq 1 ]; then
            echo "ğŸš€ åˆ›å»ºDeployment: $DEPLOYMENT_NAME (åŒ…å« $REPLICAS ä¸ªPod) - åŸºå‡†æµ‹è¯•"
          else
            echo "ğŸš€ åˆ›å»ºDeployment: $DEPLOYMENT_NAME (åŒ…å« $REPLICAS ä¸ªPod) - æ²™ç®±å¤ç”¨æµ‹è¯•"
          fi
          
          # è®°å½•Deploymentåˆ›å»ºå¼€å§‹æ—¶é—´ï¼ˆæ¯«ç§’çº§ç²¾åº¦ï¼‰
          DEPLOYMENT_START_TIME=$(date +%s%3N)
          
          # åˆ›å»ºä¼˜åŒ–çš„Deployment
          echo "  ğŸ“ åˆ›å»ºDeploymenté…ç½®: $REPLICAS ä¸ªå‰¯æœ¬"
          echo "  ğŸ¯ ç›®æ ‡: å¹¶å‘åˆ›å»º $REPLICAS ä¸ªPod"
          cat <<EOF | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: $DEPLOYMENT_NAME
          namespace: $NAMESPACE
          labels:
            app: sandbox-deployment-test
            cluster-id: "$CLUSTER_ID"
            sandbox-reuse-test: "true"
            version: "v1"
          annotations:
            deployment.kubernetes.io/revision: "1"
            description: "è¶…çº§èŠ‚ç‚¹æ²™ç®±å¤ç”¨æµ‹è¯•Deployment"
            deployment.kubernetes.io/desired-replicas: "$REPLICAS"
            created-at: "$(date -Iseconds)"
        spec:
          replicas: $REPLICAS
          
          # éƒ¨ç½²ç­–ç•¥ï¼šæ”¯æŒå¹¶å‘åˆ›å»º
          strategy:
            type: RollingUpdate
            rollingUpdate:
              maxUnavailable: 0
              maxSurge: 100%  # å…è®¸åŒæ—¶åˆ›å»ºæ‰€æœ‰Pod
          
          # è¿›åº¦æˆªæ­¢æ—¶é—´
          progressDeadlineSeconds: 600
          
          # ä¿®è®¢å†å²é™åˆ¶
          revisionHistoryLimit: 3
          
          selector:
            matchLabels:
              app: sandbox-deployment-test
              sandbox-reuse-test: "true"
          
          template:
            metadata:
              labels:
                app: sandbox-deployment-test
                cluster-id: "$CLUSTER_ID"
                sandbox-reuse-test: "true"
                version: "v1"
              annotations:
                # ç¦ç”¨LoadBalanceråŠŸèƒ½ï¼ˆè…¾è®¯äº‘ç‰¹å®šï¼‰
                service.cloud.tencent.com/direct-access: "true"
                # Podåˆ›å»ºæ—¶é—´æˆ³
                created-at: "$(date -Iseconds)"
            spec:
              # èŠ‚ç‚¹è°ƒåº¦é…ç½®
              nodeName: $node_name
              nodeSelector:
                node.kubernetes.io/instance-type: eklet
              
              # å®¹å¿åº¦é…ç½®
              tolerations:
              - operator: Exists
                effect: NoSchedule
              - operator: Exists
                effect: NoExecute
              
              # ä¼˜åŒ–Podåˆ›å»ºé€Ÿåº¦
              terminationGracePeriodSeconds: 5
              
              # äº²å’Œæ€§é…ç½®ï¼ˆå¯é€‰ï¼šåˆ†æ•£éƒ¨ç½²ï¼‰
              affinity:
                podAntiAffinity:
                  preferredDuringSchedulingIgnoredDuringExecution:
                  - weight: 50
                    podAffinityTerm:
                      labelSelector:
                        matchLabels:
                          app: sandbox-deployment-test
                      topologyKey: kubernetes.io/hostname
              
              containers:
              - name: test-container
                image: $POD_IMAGE
                imagePullPolicy: IfNotPresent
                
                resources:
                  requests:
                    cpu: $CPU_REQUEST
                    memory: $MEMORY_REQUEST
                  limits:
                    cpu: $CPU_LIMIT
                    memory: $MEMORY_LIMIT
                
                command: ["/bin/sh"]
                args: ["-c", "echo 'Pod started at \$(date) on node $node_name' && sleep 300"]
                
                # ä¼˜åŒ–çš„å°±ç»ªæ€§æ¢é’ˆ
                readinessProbe:
                  exec:
                    command: ["/bin/sh", "-c", "echo ready"]
                  initialDelaySeconds: 1
                  periodSeconds: 1
                  timeoutSeconds: 1
                  failureThreshold: 1
                
                # å­˜æ´»æ€§æ¢é’ˆ
                livenessProbe:
                  exec:
                    command: ["/bin/sh", "-c", "echo alive"]
                  initialDelaySeconds: 5
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
                
                # å®‰å…¨ä¸Šä¸‹æ–‡
                securityContext:
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: false
                  runAsNonRoot: false
              
              restartPolicy: Always
        
          if [ $? -ne 0 ]; then
            echo "  âŒ åˆ›å»ºDeploymentå¤±è´¥"
            FAILED_TESTS=$((FAILED_TESTS + 1))
            continue
          fi
          
          # ç­‰å¾…æ‰€æœ‰Podè¢«åˆ›å»ºï¼ˆä¸ç­‰å¾…å¯åŠ¨å®Œæˆï¼‰
          echo "  ğŸ“Š ç›‘æ§Podåˆ›å»ºè¿‡ç¨‹..."
          echo "  ğŸ¯ ç›®æ ‡: åˆ›å»º $REPLICAS ä¸ªPod"
          # å®‰å…¨å¤„ç†è¶…æ—¶å€¼ï¼Œæ”¯æŒå¸¦såç¼€å’Œçº¯æ•°å­—
          if [[ "$TIMEOUT" =~ ^[0-9]+s$ ]]; then
            timeout_seconds=$(echo $TIMEOUT | sed 's/s$//')
          elif [[ "$TIMEOUT" =~ ^[0-9]+$ ]]; then
            timeout_seconds=$TIMEOUT
          else
            timeout_seconds=300  # é»˜è®¤5åˆ†é’Ÿ
          fi
          count=0
          all_pods_created=false
          pod_creation_time=""
          
          # ç¬¬ä¸€é˜¶æ®µï¼šç­‰å¾…æ‰€æœ‰Podè¢«åˆ›å»ºï¼ˆä¸ç®¡æ˜¯å¦Readyï¼‰
          while [ $count -lt $timeout_seconds ]; do
            TOTAL_PODS=$(kubectl get pods -n $NAMESPACE -l sandbox-reuse-test=true --no-headers 2>/dev/null | wc -l | tr -d ' ')
            
            # æ¯3ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
            if [ $((count % 3)) -eq 0 ]; then
              echo "  â³ ç­‰å¾…Podåˆ›å»º... å½“å‰å·²åˆ›å»º: $TOTAL_PODS/$REPLICAS (${count}s)"
              # æ˜¾ç¤ºDeploymentçŠ¶æ€
              READY_REPLICAS=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
              AVAILABLE_REPLICAS=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.status.availableReplicas}' 2>/dev/null || echo "0")
              UPDATED_REPLICAS=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.status.updatedReplicas}' 2>/dev/null || echo "0")
              echo "  ğŸ“Š DeploymentçŠ¶æ€: Ready=$READY_REPLICAS, Available=$AVAILABLE_REPLICAS, Updated=$UPDATED_REPLICAS, Target=$REPLICAS"
            fi
            
            if [ "$TOTAL_PODS" -eq "$REPLICAS" ]; then
              POD_CREATION_END_TIME=$(date +%s%3N)
              # è®¡ç®—Podåˆ›å»ºæ—¶é—´ï¼ˆæ¯«ç§’çº§ç²¾åº¦ï¼‰
              pod_creation_time_ms=$((POD_CREATION_END_TIME - DEPLOYMENT_START_TIME))
              
              # è½¬æ¢ä¸ºç§’ï¼Œä¿ç•™1ä½å°æ•°
              if [ $pod_creation_time_ms -gt 0 ]; then
                # å°è¯•ä½¿ç”¨bcï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä½¿ç”¨awk
                if command -v bc >/dev/null 2>&1; then
                  pod_creation_time_sec=$(echo "scale=1; $pod_creation_time_ms / 1000" | bc)
                else
                  pod_creation_time_sec=$(echo "$pod_creation_time_ms" | awk '{printf "%.1f", $1/1000}')
                fi
              else
                pod_creation_time_sec="0.1"
              fi
              
              echo "  âœ… æ‰€æœ‰ $REPLICAS ä¸ªPodå·²åˆ›å»ºï¼Œåˆ›å»ºè€—æ—¶: ${pod_creation_time_sec}ç§’ (${pod_creation_time_ms}ms)"
              all_pods_created=true
              break
            fi
            
            if [ $((count % 5)) -eq 0 ] && [ $count -gt 0 ]; then
              echo "  â³ ç­‰å¾…Podåˆ›å»º... å½“å‰å·²åˆ›å»º: $TOTAL_PODS/$REPLICAS (${count}s)"
            fi
            
            sleep 0.1  # æ›´ç²¾ç¡®çš„ç›‘æ§é—´éš”
            count=$((count + 1))
          done
          
          if [ "$all_pods_created" = "false" ]; then
            echo "  âŒ Podåˆ›å»ºè¶…æ—¶"
            FAILED_TESTS=$((FAILED_TESTS + 1))
            kubectl delete deployment $DEPLOYMENT_NAME -n $NAMESPACE --grace-period=0 --force >/dev/null 2>&1 || true
            continue
          fi
          
          # è®°å½•Podåˆ›å»ºæ—¶é—´
          if [ -z "$STARTUP_TIMES" ]; then
            STARTUP_TIMES="$pod_creation_time_sec"
          else
            STARTUP_TIMES="$STARTUP_TIMES $pod_creation_time_sec"
          fi
          
          # ç¬¬äºŒé˜¶æ®µï¼šç­‰å¾…Podå°±ç»ªï¼ˆç”¨äºéªŒè¯åŠŸèƒ½æ­£å¸¸ï¼‰
          echo "  â³ ç­‰å¾…Podå°±ç»ªéªŒè¯..."
          ready_count=0
          while [ $ready_count -lt 60 ]; do  # æœ€å¤šç­‰å¾…60ç§’éªŒè¯
            READY_REPLICAS=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
            
            if [ "$READY_REPLICAS" = "$REPLICAS" ]; then
              echo "  âœ… æ‰€æœ‰Podå·²å°±ç»ªï¼ŒåŠŸèƒ½éªŒè¯é€šè¿‡"
              break
            fi
            
            sleep 1
            ready_count=$((ready_count + 1))
          done
              
          # è·å–Podè¯¦ç»†ä¿¡æ¯
          POD_NAMES=$(kubectl get pods -n $NAMESPACE -l sandbox-reuse-test=true -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
          pod_count=0
          echo "  ğŸ“Š Podåˆ›å»ºè¯¦æƒ…:"
          for pod_name in $POD_NAMES; do
            if [ -n "$pod_name" ]; then
              pod_count=$((pod_count + 1))
              NODE_NAME=$(kubectl get pod $pod_name -n $NAMESPACE -o jsonpath='{.spec.nodeName}' 2>/dev/null || echo "unknown")
              CREATION_TIME=$(kubectl get pod $pod_name -n $NAMESPACE -o jsonpath='{.metadata.creationTimestamp}' 2>/dev/null || echo "unknown")
              POD_PHASE=$(kubectl get pod $pod_name -n $NAMESPACE -o jsonpath='{.status.phase}' 2>/dev/null || echo "unknown")
              echo "    Pod-$pod_count: $pod_name"
              echo "      èŠ‚ç‚¹: $NODE_NAME"
              echo "      åˆ›å»ºæ—¶é—´: $CREATION_TIME"
              echo "      çŠ¶æ€: $POD_PHASE"
            fi
          done
          echo "  ğŸ“ˆ æµ‹è¯•ç»“æœ: åˆ›å»ºäº† $pod_count ä¸ªPodï¼Œè€—æ—¶ ${pod_creation_time_sec}ç§’"
          
          SUCCESSFUL_TESTS=$((SUCCESSFUL_TESTS + 1))
          if [ $i -eq 1 ]; then
            echo "  ğŸ‰ åŸºå‡†æµ‹è¯•æˆåŠŸ"
          else
            echo "  ğŸ‰ æ²™ç®±å¤ç”¨æµ‹è¯•æˆåŠŸ"
          fi
            
          # ç­‰å¾…20ç§’ååˆ é™¤Deploymentï¼ˆæŒ‰éœ€æ±‚ï¼‰
          DELAY_SECONDS=$(echo $DELAY | sed 's/s$//')
          echo "  â±ï¸  ç­‰å¾… ${DELAY_SECONDS}ç§’ åé”€æ¯Pod..."
          sleep $DELAY_SECONDS
          
          # åˆ é™¤Deployment
          echo "  ğŸ—‘ï¸  é”€æ¯Deploymentå’Œæ‰€æœ‰Pod..."
          kubectl delete deployment $DEPLOYMENT_NAME -n $NAMESPACE --grace-period=0 --force >/dev/null 2>&1 || true
          
          # ç­‰å¾…èµ„æºå®Œå…¨åˆ é™¤
          echo "  â³ ç­‰å¾…èµ„æºå®Œå…¨åˆ é™¤..."
          delete_count=0
          while kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE >/dev/null 2>&1 || kubectl get pods -n $NAMESPACE -l sandbox-reuse-test=true --no-headers 2>/dev/null | grep -q .; do
            sleep 1
            delete_count=$((delete_count + 1))
            if [ $delete_count -gt 60 ]; then
              echo "  âš ï¸  èµ„æºåˆ é™¤è¶…æ—¶ï¼Œå¼ºåˆ¶ç»§ç»­"
              break
            fi
            if [ $((delete_count % 10)) -eq 0 ]; then
              echo "    ç­‰å¾…èµ„æºåˆ é™¤... (${delete_count}s)"
            fi
          done
          echo "  âœ… æ‰€æœ‰èµ„æºå·²åˆ é™¤"
          
          # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æµ‹è¯•ï¼Œå‡†å¤‡æ²™ç®±å¤ç”¨æµ‹è¯•
          if [ $i -eq 1 ]; then
            echo "  ğŸ”„ å‡†å¤‡æ²™ç®±å¤ç”¨æµ‹è¯•..."
            sleep 2  # çŸ­æš‚ç­‰å¾…ï¼Œè®©æ²™ç®±ç³»ç»Ÿå‡†å¤‡å¤ç”¨
            echo ""
          fi
        done
        
        # æµ‹è¯•ç»“æœåˆ†æ
        echo ""
        echo "========================================"
        echo "æµ‹è¯•ç»“æœåˆ†æ"
        echo "========================================"
        
        # è®¡ç®—å¹³å‡Podåˆ›å»ºæ—¶é—´ï¼ˆç§’ï¼‰
        if [ -n "$STARTUP_TIMES" ]; then
          TOTAL_TIME=0
          COUNT=0
          echo "ğŸ” è°ƒè¯•ï¼šSTARTUP_TIMES = '$STARTUP_TIMES'"
          for time in $STARTUP_TIMES; do
            echo "ğŸ” è°ƒè¯•ï¼šå¤„ç†æ—¶é—´ = '$time'"
            # å¤„ç†å°æ•°æ—¶é—´ï¼Œè½¬æ¢ä¸ºæ•´æ•°æ¯«ç§’è¿›è¡Œè®¡ç®—
            if command -v bc >/dev/null 2>&1; then
              time_ms=$(echo "$time * 1000" | bc)
            else
              time_ms=$(echo "$time" | awk '{printf "%d", $1*1000}')
            fi
            TOTAL_TIME=$((TOTAL_TIME + time_ms))
            COUNT=$((COUNT + 1))
          done
          # è½¬æ¢å›ç§’ï¼Œä¿ç•™1ä½å°æ•°
          if command -v bc >/dev/null 2>&1; then
            AVG_TIME=$(echo "scale=1; $TOTAL_TIME / $COUNT / 1000" | bc)
          else
            AVG_TIME=$(echo "$TOTAL_TIME $COUNT" | awk '{printf "%.1f", $1/$2/1000}')
          fi
          echo "ğŸ” è°ƒè¯•ï¼šå¹³å‡æ—¶é—´ = ${AVG_TIME}ç§’"
        else
          AVG_TIME="0.0"
          COUNT=0
        fi
        
        echo "ğŸ“Š åŸºç¡€ç»Ÿè®¡:"
        echo "  æ€»æµ‹è¯•æ¬¡æ•°: $TOTAL_TESTS"
        echo "  æˆåŠŸæ¬¡æ•°: $SUCCESSFUL_TESTS"
        echo "  å¤±è´¥æ¬¡æ•°: $FAILED_TESTS"
        if [ $TOTAL_TESTS -gt 0 ]; then
          SUCCESS_RATE=$(( SUCCESSFUL_TESTS * 100 / TOTAL_TESTS ))
          echo "  æˆåŠŸç‡: ${SUCCESS_RATE}%"
        fi
        echo "  å¹³å‡Podåˆ›å»ºæ—¶é—´: ${AVG_TIME}ç§’ (ä¸å«å¯åŠ¨æ—¶é—´)"
        
        # è¯¦ç»†æ—¶é—´ç»Ÿè®¡
        if [ -n "$STARTUP_TIMES" ] && [ $COUNT -gt 0 ]; then
          echo ""
          echo "ğŸ“ˆ è¯¦ç»†æ—¶é—´ç»Ÿè®¡ (Podåˆ›å»ºæ—¶é—´ï¼Œä¸å«å¯åŠ¨æ—¶é—´):"
          test_num=1
          for time in $STARTUP_TIMES; do
            if [ $test_num -eq 1 ]; then
              echo "  åŸºå‡†æµ‹è¯•: ${time}ç§’"
            elif [ $test_num -eq 2 ]; then
              echo "  æ²™ç®±å¤ç”¨æµ‹è¯•: ${time}ç§’"
            else
              echo "  ç¬¬${test_num}æ¬¡æµ‹è¯•: ${time}ç§’"
            fi
            test_num=$((test_num + 1))
          done
        fi
        
        # æ²™ç®±å¤ç”¨æ•ˆæœåˆ†æ
        if [ -n "$STARTUP_TIMES" ] && [ $COUNT -eq 2 ]; then
          FIRST_TIME=$(echo $STARTUP_TIMES | awk '{print $1}')
          SECOND_TIME=$(echo $STARTUP_TIMES | awk '{print $2}')
          echo ""
          echo "ğŸ”„ æ²™ç®±å¤ç”¨æ•ˆæœåˆ†æ:"
          echo "  åŸºå‡†æµ‹è¯•ï¼ˆé¦–æ¬¡åˆ›å»ºæ²™ç®±ï¼‰: ${FIRST_TIME}ç§’"
          echo "  æ²™ç®±å¤ç”¨æµ‹è¯•: ${SECOND_TIME}ç§’"
          
          if [ $FIRST_TIME -gt $SECOND_TIME ]; then
            IMPROVEMENT=$((FIRST_TIME - SECOND_TIME))
            if [ $FIRST_TIME -gt 0 ]; then
              IMPROVEMENT_PERCENT=$(( IMPROVEMENT * 100 / FIRST_TIME ))
            else
              IMPROVEMENT_PERCENT=0
            fi
            echo "  ğŸš€ æ€§èƒ½æå‡: ${IMPROVEMENT}ç§’ (${IMPROVEMENT_PERCENT}%)"
            
            if [ $IMPROVEMENT -ge 3 ]; then
              echo "  âœ… æ²™ç®±å¤ç”¨æ•ˆæœæ˜¾è‘— (æå‡è¶…è¿‡3ç§’)"
            elif [ $IMPROVEMENT -ge 1 ]; then
              echo "  âœ… æ²™ç®±å¤ç”¨æ•ˆæœæ˜æ˜¾ (æå‡è¶…è¿‡1ç§’)"
            elif [ $IMPROVEMENT -ge 1 ]; then
              echo "  ğŸŸ¡ æ²™ç®±å¤ç”¨æ•ˆæœè½»å¾® (æå‡1ç§’ä»¥å†…)"
            else
              echo "  âš ï¸  æ²™ç®±å¤ç”¨æ•ˆæœå¾®å¼± (æå‡å°äº1ç§’)"
            fi
          elif [ $SECOND_TIME -gt $FIRST_TIME ]; then
            DEGRADATION=$((SECOND_TIME - FIRST_TIME))
            if [ $FIRST_TIME -gt 0 ]; then
              DEGRADATION_PERCENT=$(( DEGRADATION * 100 / FIRST_TIME ))
            else
              DEGRADATION_PERCENT=0
            fi
            echo "  âš ï¸  æ€§èƒ½ä¸‹é™: ${DEGRADATION}ç§’ (${DEGRADATION_PERCENT}%)"
            echo "  ğŸ“ å¯èƒ½åŸå› : èŠ‚ç‚¹è´Ÿè½½ã€ç½‘ç»œå»¶è¿Ÿæˆ–æ²™ç®±å¤ç”¨æœªç”Ÿæ•ˆ"
          else
            echo "  ğŸ“Š ä¸¤æ¬¡åˆ›å»ºæ—¶é—´ç›¸åŒ: ${FIRST_TIME}ç§’"
            echo "  ğŸ“ æ²™ç®±å¤ç”¨å¯èƒ½ç”Ÿæ•ˆï¼Œä½†æ€§èƒ½æå‡ä¸æ˜æ˜¾"
          fi
          
        elif [ $COUNT -eq 1 ]; then
          echo ""
          echo "âš ï¸  åªå®Œæˆäº†ä¸€æ¬¡æµ‹è¯•ï¼Œæ— æ³•è¿›è¡Œæ²™ç®±å¤ç”¨å¯¹æ¯”åˆ†æ"
          echo "ğŸ“ éœ€è¦å®Œæˆä¸¤æ¬¡æµ‹è¯•æ‰èƒ½åˆ†ææ²™ç®±å¤ç”¨æ•ˆæœ"
        else
          echo ""
          echo "ğŸ“ æµ‹è¯•æ•°æ®å¼‚å¸¸ï¼Œæ— æ³•åˆ†ææ²™ç®±å¤ç”¨æ•ˆæœ"
        fi
        
        # æ¸…ç†æµ‹è¯•èµ„æº
        echo ""
        echo "æ¸…ç†æµ‹è¯•èµ„æº..."
        kubectl delete deployments -n $NAMESPACE -l sandbox-reuse-test=true --grace-period=0 --force >/dev/null 2>&1 || true
        kubectl delete pods -n $NAMESPACE -l sandbox-reuse-test=true --grace-period=0 --force >/dev/null 2>&1 || true
        
        # ç­‰å¾…èµ„æºå®Œå…¨æ¸…ç†
        cleanup_count=0
        while kubectl get pods -n $NAMESPACE -l sandbox-reuse-test=true --no-headers 2>/dev/null | grep -q .; do
          sleep 1
          cleanup_count=$((cleanup_count + 1))
          if [ $cleanup_count -gt 30 ]; then
            echo "âš ï¸  æ¸…ç†è¶…æ—¶ï¼Œä½†ç»§ç»­å®Œæˆæµ‹è¯•"
            break
          fi
        done
        
        # æµ‹è¯•å®Œæˆ
        echo ""
        echo "========================================"
        echo "æ²™ç®±å¤ç”¨æµ‹è¯•å®Œæˆï¼"
        echo "========================================"
        FINAL_RESULT=$([ $FAILED_TESTS -eq 0 ] && echo "SUCCESS" || echo "PARTIAL_FAILURE")
        echo "æœ€ç»ˆç»“æœ: $FINAL_RESULT"
        echo "å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "æµ‹è¯•èŠ‚ç‚¹: $node_name"
        echo "Podå‰¯æœ¬æ•°: $REPLICAS"
        echo ""
        
        # å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        # å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        echo "ï¿½ æ£€æŸ¥ä¼ä¸šå¾®ä¿¡å¾®é€šçŸ¥é…ç½®..."
        echo "Webhook URL: '$WEBHOOK_URL'"
        if [ -n "$WEBHOOK_URL" ] && [ "$WEBHOOK_URL" != "" ] && [ "$WEBHOOK_URL" != "YOUR_WEBHOOK_KEY" ]; then
          echo "ï¿½ æœªå‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥..."
          
          # æ„å»ºé€šçŸ¥å†…å®¹
          if [ $FAILED_TESTS -eq 0 ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="å…¨éƒ¨æˆåŠŸ"
          else
            STATUS_EMOJI="âš ï¸"
            STATUS_TEXT="éƒ¨åˆ†å¤±è´¥"
          fi
          
          # è®¡ç®—æ€§èƒ½æå‡ä¿¡æ¯
          PERF_INFO=""
          if [ -n "$STARTUP_TIMES" ] && [ $COUNT -eq 2 ]; then
            FIRST_TIME=$(echo $STARTUP_TIMES | awk '{print $1}')
            SECOND_TIME=$(echo $STARTUP_TIMES | awk '{print $2}')
            if [ $FIRST_TIME -gt $SECOND_TIME ]; then
              IMPROVEMENT=$((FIRST_TIME - SECOND_TIME))
              if [ $FIRST_TIME -gt 0 ]; then
                IMPROVEMENT_PERCENT=$(( IMPROVEMENT * 100 / FIRST_TIME ))
              else
                IMPROVEMENT_PERCENT=0
              fi
              PERF_INFO="\\n**âš¡ æ€§èƒ½åˆ†æ**\\n- é¦–æ¬¡åˆ›å»º: ${FIRST_TIME}ç§’\\n- æ²™ç®±å¤ç”¨: ${SECOND_TIME}ç§’\\n- æ€§èƒ½æå‡: ${IMPROVEMENT}ç§’ (${IMPROVEMENT_PERCENT}%)"
            fi
          fi
          
          # åˆ›å»ºä¸´æ—¶JSONæ–‡ä»¶ï¼Œé¿å…è½¬ä¹‰é—®é¢˜
          echo "{" > /tmp/wechat_notification.json
          echo '  "msgtype": "markdown",' >> /tmp/wechat_notification.json
          echo '  "markdown": {' >> /tmp/wechat_notification.json
          echo "    \"content\": \"### ${STATUS_EMOJI} è¶…çº§èŠ‚ç‚¹æ²™ç®±å¤ç”¨æµ‹è¯•å®Œæˆ\\n\\n**ğŸ“‹ åŸºç¡€ä¿¡æ¯**\\n- é›†ç¾¤ID: \\\`$CLUSTER_ID\\\`\\n- å®Œæˆæ—¶é—´: \\\`$(date '+%Y-%m-%d %H:%M:%S')\\\`\\n- æµ‹è¯•èŠ‚ç‚¹: \\\`$node_name\\\`\\n- Podå‰¯æœ¬æ•°: **${REPLICAS}ä¸ª**\\n\\n**ğŸ“Š æµ‹è¯•ç»“æœ**\\n- çŠ¶æ€: **$STATUS_TEXT**\\n- æ€»æµ‹è¯•: **${TOTAL_TESTS}æ¬¡**\\n- æˆåŠŸ: **${SUCCESSFUL_TESTS}æ¬¡**\\n- å¤±è´¥: **${FAILED_TESTS}æ¬¡**\\n- å¹³å‡åˆ›å»ºæ—¶é—´: \\\`${AVG_TIME}ç§’\\\`$PERF_INFO\\n\\n> ğŸ“ˆ è¯¦ç»†åˆ†ææ•°æ®è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—\"" >> /tmp/wechat_notification.json
          echo '  }' >> /tmp/wechat_notification.json
          echo '}' >> /tmp/wechat_notification.json
          
          echo "ğŸ“¤ å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥..."
          echo "ğŸ“‹ é€šçŸ¥å†…å®¹é¢„è§ˆ:"
          cat /tmp/wechat_notification.json
          echo ""
          
          # å‘é€é€šçŸ¥
          if curl -s -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @/tmp/wechat_notification.json > /tmp/webhook_response 2>&1; then
            
            echo "ğŸ“¨ curlè¯·æ±‚å·²å‘é€ï¼Œæ£€æŸ¥å“åº”..."
            echo "ğŸ“„ å“åº”å†…å®¹: $(cat /tmp/webhook_response 2>/dev/null || echo 'æ— å“åº”')"
            
            # æ£€æŸ¥å“åº”
            if grep -q '"errcode":0' /tmp/webhook_response 2>/dev/null; then
              echo "âœ… ä¼ä¸šå¾®ä¿¡é€šçŸ¥å‘é€æˆåŠŸ"
            elif grep -q '"errcode"' /tmp/webhook_response 2>/dev/null; then
              ERRCODE=$(grep -o '"errcode":[0-9]*' /tmp/webhook_response | cut -d: -f2)
              ERRMSG=$(grep -o '"errmsg":"[^"]*"' /tmp/webhook_response | cut -d: -f2 | tr -d '"')
              echo "âš ï¸ ä¼ä¸šå¾®ä¿¡é€šçŸ¥å‘é€å¤±è´¥ï¼Œé”™è¯¯ç : $ERRCODE, é”™è¯¯ä¿¡æ¯: $ERRMSG"
            else
              echo "âš ï¸ ä¼ä¸šå¾®ä¿¡é€šçŸ¥å‘é€å¤±è´¥ï¼Œå“åº”: $(cat /tmp/webhook_response 2>/dev/null || echo 'æ— å“åº”')"
            fi
          else
            echo "âŒ curlè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œwebhookåœ°å€"
            echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
            echo "  Webhook URL: $WEBHOOK_URL"
            echo "  ç½‘ç»œè¿é€šæ€§æµ‹è¯•:"
            curl -s --connect-timeout 5 -I "https://qyapi.weixin.qq.com" || echo "  æ— æ³•è¿æ¥åˆ°ä¼ä¸šå¾®ä¿¡API"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/webhook_response /tmp/wechat_notification.json
        else
          echo "ğŸ“ æœªé…ç½®æœ‰æ•ˆçš„ä¼ä¸šå¾®ä¿¡webhookï¼Œè·³è¿‡é€šçŸ¥"
          echo "   å½“å‰webhook: '$WEBHOOK_URL'"
        fi
        
        # æ ¹æ®æµ‹è¯•ç»“æœå†³å®šé€€å‡ºçŠ¶æ€
        if [ $FAILED_TESTS -eq 0 ]; then
          echo "success" > /tmp/result
          echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•éƒ½æˆåŠŸå®Œæˆï¼"
        else
          echo "partial_failure" > /tmp/result
          echo "âš ï¸ æœ‰ $FAILED_TESTS ä¸ªæµ‹è¯•å¤±è´¥ï¼Œä½†è„šæœ¬æ­£å¸¸å®Œæˆ"
        fi
      outputs:
        parameters:
        - name: result
          valueFrom:
            path: /tmp/result 
 # ä¼ä¸šå¾®ä¿¡é€šçŸ¥æ¨¡æ¿
  - name: send-wechat-notification
    inputs:
      parameters:
      - name: stage
        description: "æµ‹è¯•é˜¶æ®µ"
      - name: cluster-id
        description: "é›†ç¾¤ID"
      - name: pod-replicas
        description: "Podå‰¯æœ¬æ•°"
        default: "1"
      - name: test-node
        description: "æµ‹è¯•èŠ‚ç‚¹"
        default: "unknown"
      - name: test-status
        description: "æµ‹è¯•çŠ¶æ€"
        default: "SUCCESS"
      - name: total-tests
        description: "æ€»æµ‹è¯•æ¬¡æ•°"
        default: "2"
      - name: successful-tests
        description: "æˆåŠŸæµ‹è¯•æ¬¡æ•°"
        default: "2"
      - name: failed-tests
        description: "å¤±è´¥æµ‹è¯•æ¬¡æ•°"
        default: "0"
      - name: average-time
        description: "å¹³å‡åˆ›å»ºæ—¶é—´"
        default: "0"
      - name: first-time
        description: "é¦–æ¬¡åˆ›å»ºæ—¶é—´"
        default: "0"
      - name: second-time
        description: "æ²™ç®±å¤ç”¨æ—¶é—´"
        default: "0"
      - name: improvement
        description: "æ€§èƒ½æå‡"
        default: "0"
      - name: improvement-percent
        description: "æ€§èƒ½æå‡ç™¾åˆ†æ¯”"
        default: "0"
      - name: details-message
        description: "è¯¦ç»†ä¿¡æ¯"
        default: ""
      - name: webhook-url
        description: "ä¼ä¸šå¾®ä¿¡webhookåœ°å€"
    
    script:
      image: busybox:1.37.0
      command: [sh]
      source: |
        # æ£€æŸ¥webhook-urlæ˜¯å¦ä¸ºç©º
        WEBHOOK_URL="{{inputs.parameters.webhook-url}}"
        if [ -z "$WEBHOOK_URL" ] || [ "$WEBHOOK_URL" = "" ]; then
          echo "ğŸ“ æœªé…ç½®ä¼ä¸šå¾®ä¿¡webhookï¼Œè·³è¿‡é€šçŸ¥"
          exit 0
        fi
        
        echo "ğŸ“¨ ä¼ä¸šå¾®ä¿¡é€šçŸ¥åŠŸèƒ½æš‚æ—¶ç®€åŒ–å¤„ç†"
        echo "å¦‚éœ€å®Œæ•´é€šçŸ¥åŠŸèƒ½ï¼Œè¯·ç›´æ¥åœ¨æµ‹è¯•è„šæœ¬ä¸­å¤„ç†"