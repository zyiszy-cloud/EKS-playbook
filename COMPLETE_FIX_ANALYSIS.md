# å®Œæ•´ä¿®å¤åˆ†æï¼šè„šæœ¬ã€æ¨¡æ¿ã€å·¥ä½œæµå…³ç³»

## ğŸ” æ·±åº¦é—®é¢˜åˆ†æ

ç»è¿‡ä»”ç»†æ£€æŸ¥è„šæœ¬ã€æ¨¡æ¿ã€å·¥ä½œæµä¹‹é—´çš„å…³ç³»ï¼Œæˆ‘å‘ç°äº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

### é—®é¢˜1ï¼šæ¨¡æ¿ä¸­å‚æ•°ä¼ é€’æ ¼å¼é”™è¯¯

**ä½ç½®**ï¼š`playbook/template/supernode-sandbox-deployment-template.yaml` ç¬¬194è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```bash
ITERATIONS={{inputs.parameters.test-iterations}}  # âŒ ç¼ºå°‘åŒå¼•å·
```

**ä¿®å¤å**ï¼š
```bash
ITERATIONS="{{inputs.parameters.test-iterations}}"  # âœ… æ·»åŠ åŒå¼•å·
```

**å½±å“**ï¼šåœ¨YAMLä¸­ï¼Œæ²¡æœ‰åŒå¼•å·çš„å‚æ•°å¯èƒ½å¯¼è‡´å‚æ•°ä¼ é€’å¤±è´¥æˆ–è¢«è§£æä¸ºé»˜è®¤å€¼ã€‚

### é—®é¢˜2ï¼šä¸€é”®éƒ¨ç½²è„šæœ¬ç¼ºå°‘test-iterationså‚æ•°æ›¿æ¢

**ä½ç½®**ï¼š`scripts/deploy-all.sh` å‚æ•°æ›¿æ¢éƒ¨åˆ†

**é—®é¢˜**ï¼šè„šæœ¬åªæ›¿æ¢äº†replicasã€webhook-urlã€cluster-idï¼Œä½†æ²¡æœ‰æ›¿æ¢test-iterationså‚æ•°ã€‚

**ä¿®å¤å‰**ï¼š
```bash
# æ›¿æ¢å‰¯æœ¬æ•°
sed -i.bak "/- name: replicas/,/value:/ s/value: \"[0-9]*\"/value: \"$REPLICAS\"/" "$temp_workflow"

# æ›¿æ¢webhook URL
sed -i.bak "/- name: webhook-url/,/value:/ s|value: \".*\"|value: \"$WEBHOOK_URL\"|" "$temp_workflow"

# æ›¿æ¢é›†ç¾¤ID
sed -i.bak "/- name: cluster-id/,/value:/ s/value: \".*\"/value: \"$CLUSTER_ID\"/" "$temp_workflow"

# âŒ ç¼ºå°‘test-iterationsçš„æ›¿æ¢
```

**ä¿®å¤å**ï¼š
```bash
# æ›¿æ¢å‰¯æœ¬æ•°
sed -i.bak "/- name: replicas/,/value:/ s/value: \"[0-9]*\"/value: \"$REPLICAS\"/" "$temp_workflow"

# æ›¿æ¢webhook URL
sed -i.bak "/- name: webhook-url/,/value:/ s|value: \".*\"|value: \"$WEBHOOK_URL\"|" "$temp_workflow"

# æ›¿æ¢é›†ç¾¤ID
sed -i.bak "/- name: cluster-id/,/value:/ s/value: \".*\"/value: \"$CLUSTER_ID\"/" "$temp_workflow"

# âœ… æ·»åŠ test-iterationsçš„æ›¿æ¢
sed -i.bak "/- name: test-iterations/,/value:/ s/value: \"[0-9]*\"/value: \"$ITERATIONS\"/" "$temp_workflow"
```

## ğŸ”— è„šæœ¬ã€æ¨¡æ¿ã€å·¥ä½œæµå…³ç³»å›¾

```
ç”¨æˆ·æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        â†“
scripts/deploy-all.sh
        â†“
é€‰æ‹©éƒ¨ç½²æ¨¡å¼
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    éƒ¨ç½²æ¨¡å¼åˆ†æ”¯                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¨¡å¼1: å¿«é€Ÿéƒ¨ç½²                                             â”‚
â”‚   â†’ ä½¿ç”¨ examples/sandbox-reuse-precise-test.yaml          â”‚
â”‚   â†’ ç›´æ¥ kubectl create -f                                 â”‚
â”‚                                                             â”‚
â”‚ æ¨¡å¼2: è‡ªå®šä¹‰éƒ¨ç½²ï¼ˆç”¨æˆ·å¸¸ç”¨ï¼‰                               â”‚
â”‚   â†’ å¤åˆ¶ examples/sandbox-reuse-precise-test.yaml          â”‚
â”‚   â†’ sed æ›¿æ¢å‚æ•°ï¼ˆreplicas, webhook-url, cluster-idï¼‰      â”‚
â”‚   â†’ âŒ ä¹‹å‰ç¼ºå°‘ test-iterations æ›¿æ¢                        â”‚
â”‚   â†’ âœ… ç°åœ¨æ·»åŠ äº† test-iterations æ›¿æ¢                      â”‚
â”‚   â†’ kubectl create -f ä¿®æ”¹åçš„æ–‡ä»¶                         â”‚
â”‚                                                             â”‚
â”‚ æ¨¡å¼3: å®Œå…¨äº¤äº’                                             â”‚
â”‚   â†’ åŠ¨æ€åˆ›å»ºå·¥ä½œæµYAML                                      â”‚
â”‚   â†’ ç›´æ¥ä½¿ç”¨ $ITERATIONS å˜é‡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
åˆ›å»º Workflow å®ä¾‹
        â†“
å¼•ç”¨ ClusterWorkflowTemplate
        â†“
playbook/template/supernode-sandbox-deployment-template.yaml
        â†“
å‚æ•°ä¼ é€’åˆ°æ¨¡æ¿å†…éƒ¨
        â†“
ITERATIONS="{{inputs.parameters.test-iterations}}"  # âœ… ä¿®å¤äº†åŒå¼•å·
        â†“
æ‰§è¡Œæµ‹è¯•é€»è¾‘
        â†“
for i in $(seq 1 $ITERATIONS); do  # ç°åœ¨èƒ½æ­£ç¡®è·å–åˆ°2
```

## ğŸ¯ ä¿®å¤æ•ˆæœåˆ†æ

### ä¿®å¤å‰çš„é—®é¢˜é“¾

1. **examplesæ–‡ä»¶**ï¼štest-iterations = "2" âœ…
2. **è„šæœ¬å¤åˆ¶æ–‡ä»¶**ï¼šå¤åˆ¶examplesæ–‡ä»¶ âœ…
3. **è„šæœ¬å‚æ•°æ›¿æ¢**ï¼šâŒ æ²¡æœ‰æ›¿æ¢test-iterationsï¼Œä»ç„¶æ˜¯"2"
4. **æ¨¡æ¿å‚æ•°æ¥æ”¶**ï¼šâŒ åŒå¼•å·é—®é¢˜å¯¼è‡´å‚æ•°ä¼ é€’å¼‚å¸¸
5. **æœ€ç»ˆç»“æœ**ï¼šæ˜¾ç¤º1æ¬¡æµ‹è¯•

### ä¿®å¤åçš„æ­£ç¡®é“¾

1. **examplesæ–‡ä»¶**ï¼štest-iterations = "2" âœ…
2. **è„šæœ¬å¤åˆ¶æ–‡ä»¶**ï¼šå¤åˆ¶examplesæ–‡ä»¶ âœ…
3. **è„šæœ¬å‚æ•°æ›¿æ¢**ï¼šâœ… æ­£ç¡®æ›¿æ¢test-iterationsä¸º"2"
4. **æ¨¡æ¿å‚æ•°æ¥æ”¶**ï¼šâœ… æ­£ç¡®æ¥æ”¶å‚æ•°å€¼"2"
5. **æœ€ç»ˆç»“æœ**ï¼šæ˜¾ç¤º2æ¬¡æµ‹è¯•

## ğŸ§ª éªŒè¯æ–¹æ³•

### æ–¹æ³•1ï¼šä½¿ç”¨å®Œæ•´ä¿®å¤æµ‹è¯•è„šæœ¬
```bash
./test-complete-fix.sh
```

### æ–¹æ³•2ï¼šæ‰‹åŠ¨éªŒè¯å‚æ•°æ›¿æ¢
```bash
# 1. é‡æ–°éƒ¨ç½²æ¨¡æ¿
./scripts/cleanup.sh full
kubectl delete clusterworkflowtemplate --all
./scripts/deploy-all.sh --force-redeploy --skip-test

# 2. æµ‹è¯•å‚æ•°æ›¿æ¢
cp examples/sandbox-reuse-precise-test.yaml /tmp/test.yaml
sed -i.bak "/- name: test-iterations/,/value:/ s/value: \"[0-9]*\"/value: \"2\"/" /tmp/test.yaml
grep -A1 "test-iterations" /tmp/test.yaml  # åº”è¯¥æ˜¾ç¤º value: "2"

# 3. å¯åŠ¨æµ‹è¯•
kubectl apply -f /tmp/test.yaml
kubectl logs -l workflows.argoproj.io/workflow -n tke-chaos-test -f
```

### æ–¹æ³•3ï¼šä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬éªŒè¯
```bash
./scripts/deploy-all.sh
# é€‰æ‹©æ¨¡å¼2ï¼šè‡ªå®šä¹‰éƒ¨ç½²
# é…ç½®Podæ•°é‡å’Œä¼ä¸šå¾®ä¿¡é€šçŸ¥
# è§‚å¯Ÿæ—¥å¿—ä¸­æ˜¯å¦æ˜¾ç¤º"æµ‹è¯•è¿­ä»£: 2 æ¬¡"
```

## ğŸ‰ é¢„æœŸä¿®å¤æ•ˆæœ

ä¿®å¤åçš„å®Œæ•´æµ‹è¯•æµç¨‹åº”è¯¥æ˜¾ç¤ºï¼š

```
ğŸ“Š ä½¿ç”¨å†…ç½®shellè®¡ç®—ï¼Œæ¯«ç§’çº§ç²¾åº¦
ğŸ” æ¥æ”¶åˆ°çš„æµ‹è¯•å‚æ•°:
é›†ç¾¤ID: tke-cluster
æµ‹è¯•è¿­ä»£: 2  âœ… æ­£ç¡®æ˜¾ç¤º2

========================================
è¶…çº§èŠ‚ç‚¹Deploymentæ²™ç®±å¤ç”¨æ€§èƒ½æµ‹è¯•
========================================
æµ‹è¯•è¿­ä»£: 2 æ¬¡  âœ… æ­£ç¡®æ˜¾ç¤º2æ¬¡

========================================
ç¬¬1æ¬¡æµ‹è¯•ï¼šåŸºå‡†æµ‹è¯•ï¼ˆé¦–æ¬¡åˆ›å»ºæ²™ç®±ï¼‰  âœ… ç¬¬1æ¬¡æµ‹è¯•
========================================
... (ç¬¬1æ¬¡æµ‹è¯•è¿‡ç¨‹) ...

========================================
ç¬¬2æ¬¡æµ‹è¯•ï¼šæ²™ç®±å¤ç”¨æµ‹è¯•  âœ… ç¬¬2æ¬¡æµ‹è¯•
========================================
... (ç¬¬2æ¬¡æµ‹è¯•è¿‡ç¨‹) ...

ğŸ“Š æµ‹è¯•ç»“æœ
- æ€»æµ‹è¯•: 2æ¬¡  âœ… æ­£ç¡®
- æˆåŠŸ: 2æ¬¡
- å¤±è´¥: 0æ¬¡

ğŸ“Š æ²™ç®±å¤ç”¨æ•ˆæœåˆ†æ:
- åŸºå‡†æµ‹è¯•: 3.5ç§’  âœ… æœ‰å®é™…æ•°æ®
- æ²™ç®±å¤ç”¨: 2.9ç§’  âœ… æœ‰å®é™…æ•°æ®
- ç»“è®º: æ€§èƒ½æå‡æ˜æ˜¾ï¼Œæ²™ç®±å¤ç”¨ç”Ÿæ•ˆ  âœ… æœ‰æ„ä¹‰çš„åˆ†æ
```

## ğŸ“ æ€»ç»“

é€šè¿‡è¿™æ¬¡æ·±åº¦åˆ†æå’Œä¿®å¤ï¼Œæˆ‘ä»¬è§£å†³äº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

1. âœ… **æ¨¡æ¿å±‚çº§**ï¼šä¿®å¤äº†å‚æ•°ä¼ é€’çš„æ ¼å¼é—®é¢˜ï¼ˆæ·»åŠ åŒå¼•å·ï¼‰
2. âœ… **è„šæœ¬å±‚çº§**ï¼šä¿®å¤äº†å‚æ•°æ›¿æ¢é€»è¾‘ç¼ºå¤±é—®é¢˜ï¼ˆæ·»åŠ test-iterationsæ›¿æ¢ï¼‰

è¿™ä¸¤ä¸ªä¿®å¤ç¡®ä¿äº†ä»ç”¨æˆ·è¾“å…¥åˆ°æœ€ç»ˆæ‰§è¡Œçš„å®Œæ•´å‚æ•°ä¼ é€’é“¾è·¯éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œä»è€Œå®ç°çœŸæ­£çš„2æ¬¡è¿­ä»£æ²™ç®±å¤ç”¨æµ‹è¯•ã€‚